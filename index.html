<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¦å²¡ä¹‹æ—… 2026</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS (Open Source Maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans TC", sans-serif;
            background-color: #f3f4f6;
            padding-bottom: 90px; /* Space for bottom nav */
            overscroll-behavior-y: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Map Container */
        #map-container {
            height: 50vh; /* Adjusted to allow list below */
            width: 100%;
            z-index: 1;
        }
        .card-shadow {
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.1);
        }
        .nav-item-active {
            color: #4F46E5;
            font-weight: 600;
        }
        .nav-item-inactive {
            color: #9CA3AF;
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">

    const { useState, useEffect, useRef, useMemo } = React;

    // --- Data: Itinerary ---
    const ITINERARY_DATA = [
        {
            dayId: 1,
            date: "2026/01/02",
            weekday: "é€±äº”",
            title: "åˆè³£è¡åˆºèˆ‡éŸ­èœå±±æ´—ç¦®",
            theme: "åœ°éµç§»å‹•ã€ç™¾è²¨ç¦è¢‹ã€åšå¤šéˆé­‚ç¾é£Ÿ",
            locations: [
                {
                    id: 'd1-1',
                    time: "16:00",
                    title: "æŠµé”ç¦å²¡æ©Ÿå ´ (FUK)",
                    type: "transport",
                    icon: "Plane",
                    locationName: "ç¦å²¡æ©Ÿå ´",
                    imageKeyword: "Fukuoka Airport",
                    lat: 33.5859, lng: 130.4507,
                    description: "æ­æ¥é§å·´å£«è‡³åœ‹å…§ç·šï¼Œè½‰ä¹˜åœ°éµã€‚",
                    details: "å…¥å¢ƒå¾Œï¼Œæ­ä¹˜ã€Œå…è²»æ¥é§å·´å£«ã€å‰å¾€åœ‹å…§ç·šèˆªå»ˆï¼ˆåœ°éµç«™ï¼‰ã€‚\n\nå‚™è¨»ï¼š1æœˆ2æ—¥äººæ½®è¼ƒå¤šï¼Œè«‹é ç•™é€šé—œæ™‚é–“ã€‚"
                },
                {
                    id: 'd1-2',
                    time: "17:00",
                    title: "ç§»å‹•ï¼šæ©Ÿå ´ â†’ é£¯åº— (æ˜¥å‰)",
                    type: "transport",
                    icon: "Train",
                    locationName: "The BREAKFAST HOTEL ç¦å²¡å¤©ç¥",
                    imageKeyword: "Fukuoka Subway",
                    lat: 33.5890, lng: 130.4020,
                    description: "åœ°éµè½‰ä¹˜ï¼šæ©Ÿå ´ç·š -> ä¸ƒéšˆç·šã€‚",
                    details: "è·¯ç·šï¼š\n1. åœ°éµæ©Ÿå ´ç·šã€Œç¦å²¡ç©ºæ¸¯ã€â†’ã€Œåšå¤šã€ã€‚\n2. è½‰ä¹˜ä¸ƒéšˆç·š â†’ã€Œå¤©ç¥å—ã€ã€‚\n3. 6è™Ÿå‡ºå£æ­¥è¡Œ5åˆ†é˜è‡³é£¯åº—ã€‚\n\nğŸ’³ æ”¯ä»˜ï¼šæ¨è–¦ä½¿ç”¨ã€JCB æ„Ÿæ‡‰ã€‘é€²å‡ºé–˜é–€ (50%å›é¥‹)ã€‚"
                },
                {
                    id: 'd1-3',
                    time: "18:10",
                    title: "å¤©ç¥ã€Œåˆè³£ã€å·¡ç¦®",
                    type: "shopping",
                    icon: "ShoppingBag",
                    locationName: "å¤©ç¥åœ°ä¸‹è¡— / PARCO",
                    imageKeyword: "Tenjin Shopping",
                    lat: 33.5900, lng: 130.3980,
                    description: "æ„Ÿå—æ—¥æœ¬éå¹´è³¼ç‰©ç†±æ°£ï¼Œæœé£¾æŠ˜æ‰£æ®ºã€‚",
                    details: "åœ°é»ï¼šæ­¥è¡Œè‡³å¤©ç¥åœ°ä¸‹è¡—ã€ç¦å²¡ PARCO æˆ– å²©ç”°å±‹ã€‚\näº®é»ï¼š1æœˆ2æ—¥æ˜¯ç™¾è²¨æŠ˜æ‰£ç¬¬ä¸€å¤©ï¼Œé›–ç„¶ç¦è¢‹å¯èƒ½æ¶å…‰ï¼Œä½†æœé£¾æŠ˜æ‰£éå¸¸å¥½è²·ã€‚"
                },
                {
                    id: 'd1-4',
                    time: "20:00",
                    title: "æ™šé¤ï¼šå…ƒç¥–ç‰›è…¸é‹ æ¨‚å¤©åœ°",
                    type: "food",
                    icon: "Utensils",
                    locationName: "å…ƒç¥–ã‚‚ã¤é‹ æ¥½å¤©åœ° å¤©ç¥è¥¿é€šã‚Šåº—",
                    imageKeyword: "Motsunabe",
                    lat: 33.5878, lng: 130.3985,
                    description: "å †å¾—åƒå±±çš„éŸ­èœï¼Œæ¶ˆé™¤é¦–æ—¥ç–²å‹ã€‚",
                    details: "ã€ä¸»é¸ã€‘æ¨‚å¤©åœ°å¤©ç¥è¥¿é€šåº—\nç‰¹è‰²ï¼šéŸ­èœå±±è¦–è¦ºéœ‡æ’¼ï¼Œè’œå‘³æ¿ƒéƒã€‚å»ºè­°é ç´„ã€‚\n\nã€å‚™æ¡ˆã€‘åšå¤šç‰›è…¸é‹ å¤§å±± (PARCO/KITTE)\nç‰¹è‰²ï¼šå‘³å™Œå£å‘³ï¼Œé©åˆå–®äººã€‚"
                },
                {
                    id: 'd1-5',
                    time: "21:30",
                    title: "æ˜¥å‰/ä¸­æ´²æ•£ç­–",
                    type: "sight",
                    icon: "Moon",
                    locationName: "æ˜¥å‰æ©‹",
                    imageKeyword: "Nakasu Neon",
                    lat: 33.5915, lng: 130.4070,
                    description: "æ­¥è¡Œå›é£¯åº—ï¼Œæ¬£è³é‚£ç‚å·å¤œæ™¯ã€‚",
                    details: "è·¯ç·šï¼šé€”ç¶“ã€Œæ˜¥å‰æ©‹ã€æ¬£è³é‚£ç‚å·çš„éœ“è™¹ç‡ˆå€’å½±èˆ‡ä¸­æ´²å¤œæ™¯ï¼Œæ­¥è¡Œå›é£¯åº—ä¼‘æ¯ã€‚"
                }
            ]
        },
        {
            dayId: 2,
            date: "2026/01/03",
            weekday: "é€±å…­",
            title: "éœ‡æ’¼å¤§ä½›ã€ç¥­å…¸èˆ‡æ·±å¤œæ‹‰éºµ",
            theme: "å—è—é™¢ã€ç‰å–ç¥­ã€æ°´ç‚Šé‹ã€ä¸€çŸ¢æ‹‰éºµ",
            locations: [
                {
                    id: 'd2-1',
                    time: "09:00",
                    title: "ç§»å‹•ï¼šå¤©ç¥ â†’ å—è—é™¢",
                    type: "transport",
                    icon: "Train",
                    locationName: "åŸæˆ¶å—è—é™¢å‰ç«™",
                    imageKeyword: "Japan Train Station",
                    lat: 33.6186, lng: 130.5630,
                    description: "åœ°éµä¸ƒéšˆç·šè½‰ JR ç¯ æ —ç·šã€‚",
                    details: "1. åœ°éµã€Œå¤©ç¥å—ã€â†’ã€Œåšå¤šã€ (ğŸ’³ JCBæ„Ÿæ‡‰)ã€‚\n2. JR ç¯ æ —ç·šã€Œåšå¤šã€â†’ã€ŒåŸæˆ¶å—è—é™¢å‰ã€ (ğŸ’³ SUICA/ç¾é‡‘)ã€‚\næ³¨æ„ï¼šJR ä¸èƒ½ç”¨ JCB æ„Ÿæ‡‰ã€‚"
                },
                {
                    id: 'd2-2',
                    time: "10:00",
                    title: "åƒæ‹œï¼šå—è—é™¢ (Nanzoin)",
                    type: "sight",
                    icon: "Camera",
                    locationName: "å—è—é™¢",
                    imageKeyword: "Nanzoin Buddha Reclining",
                    lat: 33.6200, lng: 130.5650,
                    description: "å…¨çƒæœ€å¤§é’éŠ…é‡‹è¿¦æ¶…æ§ƒåƒã€‚",
                    details: "äº®é»ï¼šè¦–è¦ºéœ‡æ’¼ã€‚è«‹æº–å‚™ 300 æ—¥åœ“ç¾é‡‘ä½œç‚ºå¤–åœ‹éŠå®¢åƒè§€è²»ã€‚"
                },
                {
                    id: 'd2-3',
                    time: "12:00",
                    title: "ç§»å‹•ï¼šå—è—é™¢ â†’ ç®±å´å®®",
                    type: "transport",
                    icon: "Train",
                    locationName: "ç®±å´å®®å‰ç«™",
                    imageKeyword: "Subway Japan",
                    lat: 33.6145, lng: 130.4225,
                    description: "JRè½‰åœ°éµè‡³ç®±å´å®®å‰ã€‚",
                    details: "1. JR å›ã€Œåšå¤šã€ (ğŸ’³ SUICA)ã€‚\n2. åœ°éµã€Œåšå¤šã€â†’ã€Œä¸­æ´²å·ç«¯ã€è½‰ç®±å´ç·šâ†’ã€Œç®±å´å®®å‰ã€ (ğŸ’³ JCBæ„Ÿæ‡‰)ã€‚"
                },
                {
                    id: 'd2-4',
                    time: "12:50",
                    title: "åˆé¤ï¼šç¥­å…¸å±‹å° (Yatai)",
                    type: "food",
                    icon: "Utensils",
                    locationName: "ç®±å´å®®åƒé“",
                    imageKeyword: "Yatai Food",
                    lat: 33.6145, lng: 130.4225,
                    description: "åƒé“ä¸Šåƒç‚’éºµã€ç« é­šç‡’ã€‚",
                    details: "ã€ä¸»é¸ã€‘ç¥­å…¸å±‹å°ï¼šç‚’éºµã€çƒ¤é­·é­šï¼Œé«”é©—å»Ÿæœƒæ°£æ°›ã€‚\nã€å‚™æ¡ˆã€‘ç®±å´é³©å¤ªéƒå•†åº—ï¼šç¥ç¤¾å°é¢å¤æ°‘å®¶å’–å•¡ï¼Œæœ‰çƒé¾éºµã€‚"
                },
                {
                    id: 'd2-5',
                    time: "13:10",
                    title: "è§€è³ï¼šç‰å–ç¥­ (Tamaseseri)",
                    type: "event",
                    icon: "Flag",
                    locationName: "ç®±å´å®®",
                    imageKeyword: "Tamaseseri Festival",
                    lat: 33.6145, lng: 130.4225,
                    description: "ä¹å·ä¸‰å¤§ç¥­å…¸ä¹‹ä¸€ï¼Œå£¯ä¸æ¶çƒã€‚",
                    details: "äº®é»ï¼šå ´é¢é™½å‰›ç†±è¡€ï¼Œå»ºè­°åœ¨æ¨“é–€é™„è¿‘å¡ä½è§€è³ã€‚"
                },
                {
                    id: 'd2-6',
                    time: "15:30",
                    title: "ç§»å‹• & åƒæ‹œï¼šæ«›ç”°ç¥ç¤¾",
                    type: "sight",
                    icon: "MapPin",
                    locationName: "æ«›ç”°ç¥ç¤¾",
                    imageKeyword: "Kushida Shrine",
                    lat: 33.5930, lng: 130.4105,
                    description: "æ­åœ°éµè‡³ä¸­æ´²å·ç«¯ï¼Œåƒæ‹œä¸¦åƒç´…è±†æ¹¯ã€‚",
                    details: "äº¤é€šï¼šåœ°éµè‡³ã€Œä¸­æ´²å·ç«¯ã€ (ğŸ’³ JCBæ„Ÿæ‡‰)ã€‚\næ´»å‹•ï¼šåƒæ‹œæ«›ç”°ç¥ç¤¾ï¼Œå•†åº—è¡—åƒã€Œå·ç«¯å–„å“‰ã€(ç´…è±†æ¹¯)ã€‚"
                },
                {
                    id: 'd2-7',
                    time: "18:30",
                    title: "æ™šé¤ï¼šåšå¤šæ°´ç‚Š æ¿±ç”°å±‹",
                    type: "food",
                    icon: "Utensils",
                    locationName: "åšå¤šæ°´ç‚Šã æ¿±ç”°å±‹ ãã†ã¦ã‚“",
                    imageKeyword: "Mizutaki Pot",
                    lat: 33.5898, lng: 130.4207,
                    description: "JRåšå¤šåŸ10æ¨“ï¼Œç²¾ç·»å–®äººå¾¡è†³ã€‚",
                    details: "ç§»å‹•ï¼šåœ°éµè‡³ã€Œåšå¤šã€ (ğŸ’³ JCBæ„Ÿæ‡‰)ã€‚\nã€ä¸»é¸ã€‘æ¿±ç”°å±‹ (JRåšå¤šåŸ10F)ï¼šç²¾ç·»å–®äººé‹ï¼Œæ¹¯é ­é«˜é›…ã€‚\nã€å‚™æ¡ˆã€‘åšå¤šè¯å‘³é³¥ (ç­‘ç´«å£)ã€‚"
                },
                {
                    id: 'd2-8',
                    time: "20:30",
                    title: "è¿”å›é£¯åº—",
                    type: "transport",
                    icon: "Train",
                    locationName: "å¤©ç¥å—",
                    imageKeyword: "Fukuoka Subway",
                    lat: 33.5890, lng: 130.4020,
                    description: "åœ°éµä¸ƒéšˆç·šï¼šåšå¤š -> å¤©ç¥å—ã€‚",
                    details: "ğŸ’³ æ”¯ä»˜ï¼šã€JCB æ„Ÿæ‡‰ã€‘"
                },
                {
                    id: 'd2-9',
                    time: "21:30",
                    title: "å®µå¤œï¼šä¸€çŸ¢æ‹‰éºµ (ä¸­æ´²)",
                    type: "food",
                    icon: "Utensils",
                    locationName: "éººå±‹ ä¸€çŸ¢",
                    imageKeyword: "Ramen Night",
                    lat: 33.5932, lng: 130.4085,
                    description: "ä¸­æ´²äººæ°£é»‘æ‹‰éºµï¼Œæ­¥è¡Œå³é”ã€‚",
                    details: "ç§»å‹•ï¼šå¾é£¯åº—æ­¥è¡Œ 5-8 åˆ†é˜ã€‚\næ¨è–¦ï¼šé»‘æ‹‰éºµ (ç„¦é¦™è’œæ²¹) èˆ‡ ç‚¸é›ç¿…ã€‚"
                }
            ]
        },
        {
            dayId: 3,
            date: "2026/01/04",
            weekday: "é€±æ—¥",
            title: "ç³¸å³¶çµ•æ™¯èˆ‡è±šéª¨ç‹‚ç†±",
            theme: "å·´å£«ä¸€æ—¥éŠã€é¾è²“æ£®æ—ã€æ³¡æ²«ç³»æ‹‰éºµ",
            locations: [
                {
                    id: 'd3-1',
                    time: "08:10",
                    title: "é£¯åº—å‡ºç™¼ (è«‹æº–æ™‚)",
                    type: "transport",
                    icon: "Train",
                    locationName: "å¤©ç¥å—ç«™",
                    imageKeyword: "Subway Station",
                    lat: 33.5890, lng: 130.4020,
                    description: "åœ°éµä¸ƒéšˆç·šå‰å¾€åšå¤šç«™ã€‚",
                    details: "è·¯ç·šï¼šåœ°éµä¸ƒéšˆç·šã€Œå¤©ç¥å—ã€â†’ã€Œåšå¤šã€ (ğŸ’³ JCBæ„Ÿæ‡‰)ã€‚\næ³¨æ„ï¼šæŠµé”å¾Œéœ€é ç•™æ™‚é–“èµ°åˆ°ã€Œç­‘ç´«å£ã€ã€‚"
                },
                {
                    id: 'd3-2',
                    time: "08:50",
                    title: "é›†åˆï¼šKlook å·´å£«ä¸€æ—¥éŠ",
                    type: "alert",
                    icon: "Users",
                    locationName: "åšå¤šç«™ç­‘ç´«å£ LAWSON",
                    imageKeyword: "Hakata Station Chikushi",
                    lat: 33.5905, lng: 130.4220,
                    description: "ç­‘ç´«å£ Oriental Hotel ä¸€æ¨“ LAWSON å‰ã€‚",
                    details: "è­˜åˆ¥ï¼šå°‹æ‰¾ Klook / EasyGo æ——å¹Ÿçš„å°éŠã€‚"
                },
                {
                    id: 'd3-3',
                    time: "09:00",
                    title: "ç³¸å³¶å·´å£«ä¸€æ—¥éŠ",
                    type: "bus",
                    icon: "Bus",
                    locationName: "ç³¸å³¶",
                    imageKeyword: "Futamigaura Torii",
                    lat: 33.6420, lng: 130.1980,
                    description: "å¤«å©¦å²©ã€é¾è²“æ£®æ—ã€ä¸€è˜­å·¥å» ã€‚",
                    details: "è¡Œç¨‹ï¼šæ«»äº•äºŒè¦‹æµ¦å¤«å©¦å²©ã€é¾è²“æ£®æ— (èŠ¥å±‹å¤§é–€)ã€ä¸€è˜­ä¹‹æ£® (åˆé¤è‡ªç†/è¼•é£Ÿ)ã€ç™½çµ²ç€‘å¸ƒã€æ¤°å­æ¨¹é¦éŸ†ã€‚"
                },
                {
                    id: 'd3-4',
                    time: "18:00",
                    title: "æŠµé”åšå¤šç«™ (è§£æ•£)",
                    type: "transport",
                    icon: "MapPin",
                    locationName: "åšå¤šç«™",
                    imageKeyword: "Hakata Station Evening",
                    lat: 33.5900, lng: 130.4206,
                    description: "æ–¼ç­‘ç´«å£é™„è¿‘è§£æ•£ã€‚",
                    details: "è§£æ•£å¾Œæº–å‚™å‰å¾€æ™šé¤åœ°é»ã€‚"
                },
                {
                    id: 'd3-5',
                    time: "18:10",
                    title: "æ™šé¤ï¼šåšå¤šä¸€é›™",
                    type: "food",
                    icon: "Utensils",
                    locationName: "åšå¤šä¸€åŒ åšå¤šé§…æ±æœ¬åº—",
                    imageKeyword: "Ramen Broth",
                    lat: 33.5888, lng: 130.4243,
                    description: "ã€Œè±šéª¨å¡å¸ƒå¥‡è«¾ã€ï¼Œæ¿ƒéƒæ³¡æ²«æ¹¯é ­ã€‚",
                    details: "ä½ç½®ï¼šç­‘ç´«å£æ­¥è¡Œ 6-8 åˆ†é˜ã€‚\nã€ä¸»é¸ã€‘åšå¤šä¸€é›™ï¼šæ’éšŠç´„ 40-60 åˆ†é˜ï¼Œå¿…åƒæ¿ƒåšè±šéª¨ã€‚\nã€å‚™æ¡ˆã€‘Shin-Shin (åšå¤šç«™å…§ 2F éºµè¡—é“)ï¼šæ¸…ç”œé †å£ï¼Œç¿»æ¡Œå¿«ã€‚"
                },
                {
                    id: 'd3-6',
                    time: "20:15",
                    title: "é£¯å¾Œæ¡è²· & è¿”å›",
                    type: "shopping",
                    icon: "ShoppingBag",
                    locationName: "åšå¤šç«™ / å¤©ç¥å—",
                    imageKeyword: "Japanese Strawberry",
                    lat: 33.5900, lng: 130.4206,
                    description: "è¶…å¸‚è²·è‰è“ï¼Œæ­åœ°éµå›é£¯åº—ã€‚",
                    details: "æ´»å‹•ï¼šåšå¤šç«™è¶…å¸‚è²·è‰è“/ä¼´æ‰‹ç¦®ã€‚\näº¤é€šï¼šåœ°éµä¸ƒéšˆç·šã€Œåšå¤šã€â†’ã€Œå¤©ç¥å—ã€ (ğŸ’³ JCBæ„Ÿæ‡‰)ã€‚"
                }
            ]
        },
        {
            dayId: 4,
            date: "2026/01/05",
            weekday: "é€±ä¸€",
            title: "å¸‚å ´é®®å‘³èˆ‡å®Œç¾å¥é»",
            theme: "å¸‚å ´é–‹å¸‚ã€èƒ¡éº»é¯–é­šã€å¾å®¹é›¢å¢ƒ",
            locations: [
                {
                    id: 'd4-1',
                    time: "10:00",
                    title: "Check-out",
                    type: "hotel",
                    icon: "Briefcase",
                    locationName: "The BREAKFAST HOTEL ç¦å²¡å¤©ç¥",
                    imageKeyword: "Luggage Hotel",
                    lat: 33.5890, lng: 130.4020,
                    description: "è¡Œæå¯„æ”¾é£¯åº—æ«ƒæª¯ (è¼•è£å‡ºé–€)ã€‚",
                    details: "ç­–ç•¥ï¼šå°‡è¡Œæå¯„æ”¾åœ¨é£¯åº—ï¼Œæ–¹ä¾¿æœ€å¾Œå›ä¾†ç›´æ¥å»æ©Ÿå ´ã€‚"
                },
                {
                    id: 'd4-2',
                    time: "10:30",
                    title: "æŸ³æ©‹é€£åˆå¸‚å ´",
                    type: "sight",
                    icon: "ShoppingBag",
                    locationName: "æŸ³æ©‹é€£åˆå¸‚å ´",
                    imageKeyword: "Yanagibashi Market",
                    lat: 33.5828, lng: 130.4045,
                    description: "æ–°å¹´é–‹å¸‚ï¼Œæ¨è–¦ç¾ç‚¸é­šæ¿ã€‚",
                    details: "äº¤é€šï¼šå¾é£¯åº—æ­¥è¡Œç´„ 8 åˆ†é˜ã€‚\nç¾é£Ÿï¼šæ¨è–¦ã€Œé«˜æ¾ä¹‹è’²é‰¾ã€ç¾ç‚¸é­šæ¿ã€‚"
                },
                {
                    id: 'd4-3',
                    time: "11:30",
                    title: "åˆé¤ï¼šåšå¤šèƒ¡éº»é¯–é­šå±‹",
                    type: "food",
                    icon: "Utensils",
                    locationName: "åšå¤šã”ã¾ã•ã°å±‹",
                    imageKeyword: "Gomasaba",
                    lat: 33.5886, lng: 130.3934,
                    description: "èµ¤å‚ååº—ï¼Œå®šé£Ÿ CP å€¼æ¥µé«˜ã€‚",
                    details: "äº¤é€šï¼šæ­¥è¡Œå›å¤©ç¥å— -> åœ°éµä¸ƒéšˆç·šè‡³å¤©ç¥ -> è½‰æ©Ÿå ´ç·šè‡³èµ¤å‚ (ğŸ’³ JCBæ„Ÿæ‡‰)ã€‚\nã€ä¸»é¸ã€‘èƒ¡éº»é¯–é­šå±‹ï¼šç”Ÿé­šç‰‡å®šé£Ÿ+èŒ¶æ³¡é£¯åƒåˆ°é£½ã€‚\nã€å‚™æ¡ˆã€‘é»‘ç”°é£¯ å¤©ç¥åº—ï¼šçƒé¾éºµ/æµ·é®®ä¸¼ï¼Œå‡ºé¤å¿«ã€‚"
                },
                {
                    id: 'd4-4',
                    time: "13:30",
                    title: "è¿”å›é£¯åº—å–è¡Œæ",
                    type: "transport",
                    icon: "Briefcase",
                    locationName: "The BREAKFAST HOTEL ç¦å²¡å¤©ç¥",
                    imageKeyword: "Hotel Lobby",
                    lat: 33.5890, lng: 130.4020,
                    description: "åœ°éµèµ¤å‚ -> å¤©ç¥...æ­¥è¡Œå›é£¯åº—ã€‚",
                    details: "äº¤é€šï¼šåœ°éµæ©Ÿå ´ç·šã€Œèµ¤å‚ã€â†’ã€Œå¤©ç¥ã€ (ğŸ’³ JCBæ„Ÿæ‡‰)ï¼Œå†æ­¥è¡Œå›é£¯åº—æ‹¿è¡Œæã€‚"
                },
                {
                    id: 'd4-5',
                    time: "14:00",
                    title: "ç§»å‹•ï¼šé£¯åº— â†’ æ©Ÿå ´",
                    type: "transport",
                    icon: "Train",
                    locationName: "ç¦å²¡æ©Ÿå ´ (FUK)",
                    imageKeyword: "Fukuoka Airport",
                    lat: 33.5859, lng: 130.4507,
                    description: "åœ°éµè½‰æ¥é§å·´å£«è‡³åœ‹éš›ç·šã€‚",
                    details: "è·¯ç·šï¼š\n1. åœ°éµä¸ƒéšˆç·šã€Œå¤©ç¥å—ã€â†’ã€Œåšå¤šã€ã€‚\n2. è½‰ä¹˜æ©Ÿå ´ç·šã€Œåšå¤šã€â†’ã€Œç¦å²¡ç©ºæ¸¯ã€ (ğŸ’³ JCBæ„Ÿæ‡‰)ã€‚\n3. è½‰ä¹˜æ©Ÿå ´å…è²»æ¥é§å·´å£«è‡³åœ‹éš›ç·šèˆªå»ˆã€‚\næ™‚é–“ï¼šé ç•™ 40-50 åˆ†é˜äº¤é€šæ™‚é–“ã€‚"
                },
                {
                    id: 'd4-6',
                    time: "14:55",
                    title: "æŠµé”æ©Ÿå ´ & å…ç¨…åº—",
                    type: "shopping",
                    icon: "Plane",
                    locationName: "ç¦å²¡æ©Ÿå ´å…ç¨…åº—",
                    imageKeyword: "Airport Duty Free",
                    lat: 33.5859, lng: 130.4507,
                    description: "æœ€å¾Œè¡åˆºï¼šMenbeiã€åšå¤šé€šé¥…é ­ã€åŠªåŠªé›ã€‚",
                    details: "èˆªç­ï¼šAK1511 (16:55 èµ·é£›)ã€‚\nå¿…è²·ï¼šåŠªåŠªé› (å†·ç‚¸é›)ã€Menbeiã€åšå¤šé€šé¥…é ­ã€‚"
                }
            ]
        }
    ];

    // --- Data: Souvenirs ---
    const SOUVENIR_DATA = [
        {
            category: "ğŸ† ç¦å²¡é›™ç’§ï¼šçµ•ä¸å‡ºéŒ¯",
            items: [
                {
                    id: 's1',
                    title: "åšå¤šé€šé¥…é ­ (åšå¤šé€šã‚Šã‚‚ã‚“)",
                    tag: "ç”œé£Ÿ",
                    desc: "ç¦å²¡ä¼´æ‰‹ç¦®ç‹è€…ã€‚è¥¿æ´‹å¥¶æ²¹èˆ‡æ—¥å¼ç™½è±†æ²™æ··åˆï¼Œå£æ„Ÿç¶¿å¯†æ¿•æ½¤ï¼Œå¸¶æœ‰æ¿ƒéƒå¥¶é¦™ã€‚",
                    recommend: "è¾¦å…¬å®¤åˆ†é€ (å–®åŒ…è£)ã€é•·è¼©é€ç¦®",
                    location: "åšå¤šç«™ Ming / æ©Ÿå ´å…ç¨…åº—",
                    imageKeyword: "Japanese Manju"
                },
                {
                    id: 's2',
                    title: "ç¦å¤ªéƒ Menbei (ã‚ã‚“ã¹ã„)",
                    tag: "é¹¹é£Ÿ",
                    desc: "æ˜å¤ªå­ä»™è²ã€‚å£æ„Ÿç¡¬è„†ï¼Œæ¿ƒéƒæµ·é®®èˆ‡å¾®è¾£æ˜å¤ªå­é¦™æ°£ã€‚",
                    recommend: "é…å•¤é…’ä¸‹é…’ã€å–œæ­¡é¹¹é£Ÿè€…",
                    location: "åšå¤šç«™å„è™• / æ©Ÿå ´å…ç¨…åº—",
                    imageKeyword: "Senbei"
                }
            ]
        },
        {
            category: "ğŸœ åšå¤šç¾é£Ÿå¸¶å›å®¶",
            items: [
                {
                    id: 's3',
                    title: "åšå¤šä¸€é›™ / Shin-Shin æ‹‰éºµåŒ…",
                    tag: "æ–™ç†åŒ…",
                    desc: "ååº—é‚„åŸåº¦é«˜ã€‚ä¸€é›™ç‚ºæ¿ƒåšæ³¡æ²«ç³»ï¼ŒShin-Shin ç‚ºæ¸…ç”œç´°éºµã€‚",
                    recommend: "æ‹‰éºµæ„›å¥½è€… (å¯å¸¶å›å°ç£ï¼Œç„¡è‚‰ç‰‡)",
                    location: "åšå¤šç«™ Ming",
                    imageKeyword: "Hakata Ramen Kit"
                },
                {
                    id: 's4',
                    title: "å±±å±‹ (YAMAYA) è»Ÿç®¡æ˜å¤ªå­",
                    tag: "éœ€å†·è—",
                    desc: "ç‰™è†ç‹€åŒ…è£æ–¹ä¾¿ä½¿ç”¨ã€‚ç›´æ¥æ“ åœ¨ç™½é£¯ã€åå¸æˆ–æ‹Œç¾©å¤§åˆ©éºµã€‚",
                    recommend: "è‡ªç”¨çƒ¹é£ªã€é€çµ¦æ„›åšèœçš„æœ‹å‹",
                    location: "æ©Ÿå ´ç®¡åˆ¶å€å¤– / åšå¤šç«™",
                    imageKeyword: "Mentaiko Tube"
                },
                {
                    id: 's5',
                    title: "æŸšå­èƒ¡æ¤’ (Yuzu Kosho)",
                    tag: "èª¿å‘³",
                    desc: "ä¹å·ç‰¹æœ‰èª¿å‘³æ–™ (æŸšå­çš®+è¾£æ¤’)ã€‚ç…®ç«é‹ã€æ²¾è‚‰ç¥å™¨ã€‚",
                    recommend: "æ¨è–¦ã€ŒèŒ…ä¹ƒèˆã€å“ç‰Œ",
                    location: "åšå¤šç«™ / æ©Ÿå ´",
                    imageKeyword: "Yuzu Kosho"
                }
            ]
        },
        {
            category: "ğŸ“ å†¬å­£é™å®šï¼šç”˜ç‹è‰è“",
            items: [
                {
                    id: 's6',
                    title: "PRESS BUTTER SAND (è‰è“å‘³)",
                    tag: "ç”œé»",
                    desc: "ç¦å²¡é™å®šç´…è‰²åŒ…è£ã€‚ç„¦ç³–å¥¶æ²¹å¤¾å¿ƒï¼Œé…¸ç”œä¸è†©ã€‚",
                    recommend: "é€ç¦®é¦–é¸ï¼ŒåŒ…è£ç²¾ç¾è³ªæ„Ÿé«˜",
                    location: "åšå¤šç«™å°ˆè³£åº—",
                    imageKeyword: "Butter Sand Cookie"
                },
                {
                    id: 's7',
                    title: "ä¼Šéƒ½ King éŠ…é‘¼ç‡’",
                    tag: "ç”œé»",
                    desc: "ç³¸å³¶ç”¢è‰è“ç”œé»å°ˆè³£åº—ã€‚æ•´é¡†è‰è“æ”¾å…¥çš„éŠ…é‘¼ç‡’ã€‚",
                    recommend: "ç•¶å ´åƒæˆ–ç•¶å¤©é€ç¦®",
                    location: "åšå¤šç«™ Ming / æ©Ÿå ´",
                    imageKeyword: "Strawberry Dorayaki"
                }
            ]
        },
        {
            category: "ğŸ— å®µå¤œæ¨è–¦",
            items: [
                {
                    id: 's8',
                    title: "åŠªåŠªé› (å†·ç‚¸é›)",
                    tag: "éœ€å†·å‡",
                    desc: "å†°å†°åƒçš„ç‚¸é›ï¼Œè¶Šåƒè¶Šæ¶®å˜´ã€‚é©åˆç•¶å®µå¤œã€‚",
                    recommend: "åœ¨é£¯åº—ç•¶å®µå¤œåƒ (å¸¶å›å°ç£ç¨éº»ç…©)",
                    location: "åšå¤šç«™ / æ©Ÿå ´",
                    imageKeyword: "Fried Chicken Wings"
                }
            ]
        }
    ];

    // --- Components ---

    // 1. Icon Component
    const Icon = ({ name, size = 20, className }) => {
        const ref = useRef(null);

        useEffect(() => {
            if (!ref.current || !window.lucide) return;
            const getIconDef = (n) => {
                const { icons } = window.lucide;
                if (icons[n]) return icons[n];
                const pascal = n.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join('');
                if (icons[pascal]) return icons[pascal];
                return null;
            };
            const iconDef = getIconDef(name);
            if (!iconDef) return;

            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', size);
            svg.setAttribute('height', size);
            svg.setAttribute('viewBox', '0 0 24 24');
            svg.setAttribute('fill', 'none');
            svg.setAttribute('stroke', 'currentColor');
            svg.setAttribute('stroke-width', '2');
            svg.setAttribute('stroke-linecap', 'round');
            svg.setAttribute('stroke-linejoin', 'round');
            if (className) svg.setAttribute('class', className);

            iconDef.forEach(([tag, attrs]) => {
                const child = document.createElementNS('http://www.w3.org/2000/svg', tag);
                Object.entries(attrs).forEach(([k, v]) => child.setAttribute(k, v));
                svg.appendChild(child);
            });
            ref.current.innerHTML = '';
            ref.current.appendChild(svg);
        }, [name, size, className]);

        return <span ref={ref} className={`inline-flex items-center justify-center ${className || ''}`} style={{ width: size, height: size }}></span>;
    };

    const getIconName = (type) => {
        switch(type) {
            case 'flight': return 'plane';
            case 'hotel': return 'bed-double';
            case 'food': return 'utensils';
            case 'shopping': return 'shopping-bag';
            case 'sight': return 'camera';
            case 'transport': return 'train-front'; // Changed default transport to train as it's major here
            case 'alert': return 'alert-circle';
            case 'event': return 'flag';
            case 'bus': return 'bus';
            default: return 'map-pin';
        }
    };

    const getColorClass = (type) => {
        switch(type) {
            case 'flight': return 'bg-blue-100 text-blue-600';
            case 'hotel': return 'bg-indigo-100 text-indigo-600';
            case 'food': return 'bg-orange-100 text-orange-600';
            case 'shopping': return 'bg-pink-100 text-pink-600';
            case 'sight': return 'bg-green-100 text-green-600';
            case 'alert': return 'bg-red-100 text-red-600';
            case 'bus': return 'bg-teal-100 text-teal-600';
            default: return 'bg-gray-100 text-gray-600';
        }
    };

    // 2. Map Component (Leaflet) with List below
    const MapView = ({ activeDay, data }) => {
        const mapRef = useRef(null);
        const mapInstanceRef = useRef(null);
        const markersRef = useRef([]);

        // Derive the list of locations to show
        const locationsToShow = useMemo(() => {
            const daysToShow = activeDay === 'all' ? data : [data[activeDay]];
            const flatLocations = [];
            daysToShow.forEach((day, dIdx) => {
                day.locations.forEach((loc, lIdx) => {
                    flatLocations.push({
                        ...loc,
                        globalIndex: flatLocations.length + 1, // Number sequentially for the list
                        dayLabel: `Day ${day.dayId}`
                    });
                });
            });
            return flatLocations;
        }, [activeDay, data]);

        useEffect(() => {
            if (!mapInstanceRef.current) {
                mapInstanceRef.current = L.map('map-container').setView([33.5902, 130.4017], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap & CartoDB'
                }).addTo(mapInstanceRef.current);
            }

            // Clear existing markers
            markersRef.current.forEach(marker => mapInstanceRef.current.removeLayer(marker));
            markersRef.current = [];

            let points = [];
            
            locationsToShow.forEach((loc) => {
                const myIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color: #4F46E5; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">${loc.globalIndex}</div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                const marker = L.marker([loc.lat, loc.lng], { icon: myIcon })
                    .addTo(mapInstanceRef.current)
                    .bindPopup(`<b>${loc.globalIndex}. ${loc.title}</b><br>${loc.locationName}`);
                
                markersRef.current.push(marker);
                points.push([loc.lat, loc.lng]);
            });

            if (points.length > 0) {
                const bounds = L.latLngBounds(points);
                mapInstanceRef.current.fitBounds(bounds, { padding: [50, 50] });
            }
            
            setTimeout(() => {
                mapInstanceRef.current.invalidateSize();
            }, 100);

        }, [locationsToShow]);

        return (
            <div className="flex flex-col h-full">
                <div id="map-container" className="rounded-xl overflow-hidden shadow-inner flex-shrink-0"></div>
                
                <div className="flex-1 overflow-y-auto mt-4 px-1 pb-4">
                    <h3 className="font-bold text-gray-700 mb-3 px-1 flex items-center gap-2">
                        <Icon name="list" size={18} /> 
                        æ™¯é»åˆ—è¡¨ ({activeDay === 'all' ? 'å…¨ç¨‹' : `Day ${activeDay + 1}`})
                    </h3>
                    <div className="space-y-3">
                        {locationsToShow.map((loc) => (
                            <div key={`${loc.id}-list`} className="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-start gap-3">
                                <span className="flex-shrink-0 w-6 h-6 rounded-full bg-indigo-600 text-white flex items-center justify-center text-xs font-bold mt-0.5">
                                    {loc.globalIndex}
                                </span>
                                <div>
                                    <h4 className="font-bold text-gray-800 text-sm">{loc.title}</h4>
                                    <p className="text-xs text-gray-500 mt-0.5 flex items-center gap-1">
                                        <Icon name="map-pin" size={10} /> {loc.locationName}
                                    </p>
                                    {activeDay === 'all' && (
                                        <span className="inline-block mt-1 px-1.5 py-0.5 bg-gray-100 text-gray-500 text-[10px] rounded">
                                            {loc.dayLabel}
                                        </span>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );
    };

    // 6. Gallery View Component
    const GalleryView = ({ data }) => {
        // Flatten all locations that have image keywords
        const galleryItems = useMemo(() => {
            const items = [];
            data.forEach(day => {
                day.locations.forEach(loc => {
                    if (loc.imageKeyword) {
                        items.push({
                            ...loc,
                            dayTitle: `Day ${day.dayId}`
                        });
                    }
                });
            });
            return items;
        }, [data]);

        return (
            <div className="grid grid-cols-2 gap-3 mt-4 pb-4">
                {galleryItems.map((item) => (
                    <div key={item.id} className="bg-white rounded-xl overflow-hidden shadow-sm break-inside-avoid">
                        <div className="h-32 bg-gray-200 relative overflow-hidden">
                            <img 
                                src={`https://loremflickr.com/400/300/${encodeURIComponent(item.imageKeyword)},travel/all`} 
                                alt={item.title}
                                className="w-full h-full object-cover hover:scale-110 transition-transform duration-500"
                                loading="lazy"
                            />
                            <div className="absolute top-2 left-2 bg-black/50 backdrop-blur-md text-white text-[10px] px-2 py-0.5 rounded-full">
                                {item.dayTitle}
                            </div>
                        </div>
                        <div className="p-3">
                            <h4 className="font-bold text-gray-800 text-xs line-clamp-1 mb-1">{item.title}</h4>
                            <p className="text-[10px] text-gray-500 flex items-center gap-1">
                                <Icon name="map-pin" size={10} /> {item.locationName}
                            </p>
                        </div>
                    </div>
                ))}
            </div>
        );
    };

    // 7. Souvenir View Component
    const SouvenirView = () => {
        return (
            <div className="px-1 pb-4 mt-2">
                <h2 className="text-xl font-bold text-gray-800 mb-4 px-2">ç¦å²¡ä¼´æ‰‹ç¦®æ”»ç•¥</h2>
                
                {/* Shopping Guide Box */}
                <div className="bg-indigo-50 border border-indigo-100 rounded-xl p-4 mb-6">
                    <h3 className="font-bold text-indigo-700 text-sm mb-2 flex items-center gap-2">
                        <Icon name="shopping-bag" size={16} /> è³¼è²·æˆ°ç•¥ (é…åˆ Day 4)
                    </h3>
                    <ul className="text-xs text-gray-600 space-y-2">
                        <li className="flex gap-2 items-start">
                            <span className="font-bold text-indigo-500">åšå¤šç«™ Mingï¼š</span>
                            <span>ä¼´æ‰‹ç¦®ä¸€ç´šæˆ°å€ï¼Œå»ºè­°è²·é½Šä¹¾è²¨ (é€šé¥…é ­ã€Menbeiã€æ‹‰éºµåŒ…ã€æŸšå­èƒ¡æ¤’)ã€‚</span>
                        </li>
                        <li className="flex gap-2 items-start">
                            <span className="font-bold text-indigo-500">æ©Ÿå ´å…ç¨…åº—ï¼š</span>
                            <span>çœ 10% æ¶ˆè²»ç¨…ï¼Œå…æ¹Šé€€ç¨…ã€‚å»ºè­°è²·é€šé¥…é ­ã€Menbeiã€å°é›é¥…é ­ã€Royceï¼Œæ¸›å°‘æ‰‹æé‡é‡ã€‚</span>
                        </li>
                    </ul>
                </div>

                <div className="space-y-6">
                    {SOUVENIR_DATA.map((category, idx) => (
                        <div key={idx}>
                            <h3 className="text-sm font-bold text-gray-500 mb-3 px-2 sticky top-0 bg-[#f3f4f6] py-2 z-10">
                                {category.category}
                            </h3>
                            <div className="grid grid-cols-1 gap-3">
                                {category.items.map((item) => (
                                    <div key={item.id} className="bg-white rounded-xl p-3 shadow-sm flex gap-3">
                                        <div className="w-24 h-24 bg-gray-100 rounded-lg flex-shrink-0 overflow-hidden">
                                            <img 
                                                src={`https://loremflickr.com/200/200/${encodeURIComponent(item.imageKeyword)},food/all`}
                                                alt={item.title}
                                                className="w-full h-full object-cover"
                                                loading="lazy"
                                            />
                                        </div>
                                        <div className="flex-1 flex flex-col justify-between">
                                            <div>
                                                <div className="flex justify-between items-start mb-1">
                                                    <h4 className="font-bold text-gray-800 text-sm line-clamp-1">{item.title}</h4>
                                                    <span className={`text-[10px] px-1.5 py-0.5 rounded ${
                                                        item.tag === 'ç”œé£Ÿ' || item.tag === 'ç”œé»' ? 'bg-pink-100 text-pink-600' :
                                                        item.tag === 'é¹¹é£Ÿ' || item.tag === 'æ–™ç†åŒ…' ? 'bg-orange-100 text-orange-600' :
                                                        item.tag === 'éœ€å†·è—' || item.tag === 'éœ€å†·å‡' ? 'bg-blue-100 text-blue-600' :
                                                        'bg-gray-100 text-gray-600'
                                                    }`}>{item.tag}</span>
                                                </div>
                                                <p className="text-xs text-gray-600 leading-snug line-clamp-2">{item.desc}</p>
                                            </div>
                                            <div className="mt-2">
                                                <div className="flex items-center gap-1 text-[10px] text-gray-500">
                                                    <Icon name="thumbs-up" size={10} className="text-indigo-500"/>
                                                    <span>æ¨è–¦ï¼š{item.recommend}</span>
                                                </div>
                                                <div className="flex items-center gap-1 text-[10px] text-gray-500 mt-0.5">
                                                    <Icon name="map-pin" size={10} />
                                                    <span>{item.location}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
                
                {/* Summary List */}
                <div className="mt-8 px-2 pb-4">
                    <h4 className="font-bold text-gray-700 text-sm mb-3">ğŸ“ å¿«é€Ÿæ¸…å–®</h4>
                    <div className="bg-white rounded-xl p-4 text-xs text-gray-600 space-y-2 border border-gray-100">
                        <p>ğŸ”¹ <strong>è‡ªå·±åƒ/ç…®ï¼š</strong> æŸšå­èƒ¡æ¤’ã€è»Ÿç®¡æ˜å¤ªå­ã€åšå¤šä¸€é›™æ‹‰éºµåŒ…</p>
                        <p>ğŸ”¹ <strong>é€åŒäº‹/æœ‹å‹ï¼š</strong> åšå¤šé€šé¥…é ­ (æ¥å—åº¦æœ€é«˜)</p>
                        <p>ğŸ”¹ <strong>é€è‡ªå·±/å®¶äººï¼š</strong> PRESS BUTTER SAND (è‰è“å£å‘³)</p>
                        <p>ğŸ”¹ <strong>å®µå¤œ (æ—¥æœ¬åƒå®Œ)ï¼š</strong> åŠªåŠªé›</p>
                    </div>
                </div>
            </div>
        );
    };

    // 3. Hero Section (Forecast + Currency)
    const HeroSection = ({ activeDayIndex, itineraryData }) => {
        const [expanded, setExpanded] = useState(true);
        const [forecast, setForecast] = useState(null);
        const [jpyRate, setJpyRate] = useState(0.22); 
        const [amount, setAmount] = useState('');
        const [converted, setConverted] = useState(null);
        const [rateDate, setRateDate] = useState('');

        useEffect(() => {
            fetch('https://api.open-meteo.com/v1/forecast?latitude=33.5902&longitude=130.4017&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo')
                .then(res => res.json())
                .then(data => setForecast(data.daily))
                .catch(err => console.error("Weather fetch failed", err));

            fetch('https://api.exchangerate-api.com/v4/latest/JPY')
                .then(res => res.json())
                .then(data => {
                    if(data.rates.TWD) {
                        setJpyRate(data.rates.TWD);
                        setRateDate(data.date);
                    }
                })
                .catch(err => console.error("Rate fetch failed", err));
        }, []);

        const handleConvert = () => {
            if(!amount) return;
            setConverted((parseFloat(amount) * jpyRate).toFixed(0));
        };

        const getWeatherDescription = (code) => {
            if (code === 0) return 'æ™´æœ—';
            if (code <= 3) return 'å¤šé›²';
            if (code <= 48) return 'æœ‰éœ§';
            if (code <= 67) return 'æœ‰é›¨';
            if (code <= 77) return 'é™é›ª';
            if (code <= 82) return 'é™£é›¨';
            return 'é™°é›¨';
        };

        const currentDayIdx = typeof activeDayIndex === 'number' ? activeDayIndex : 0;
        
        const todayForecast = forecast ? {
            max: forecast.temperature_2m_max[currentDayIdx],
            min: forecast.temperature_2m_min[currentDayIdx],
            code: forecast.weathercode[currentDayIdx],
            desc: getWeatherDescription(forecast.weathercode[currentDayIdx])
        } : null;

        const displayDate = typeof activeDayIndex === 'number' 
            ? itineraryData[activeDayIndex].date.slice(5) 
            : "å…¨ç¨‹ç¸½è¦½";
        
        const displayLocation = typeof activeDayIndex === 'number' 
             ? "ç¦å²¡å¸‚" 
             : "ç¦å²¡ç¸£";

        if (!expanded) {
            return (
                <div 
                    onClick={() => setExpanded(true)}
                    className="bg-indigo-600 text-white shadow-lg transition-all duration-300 cursor-pointer overflow-hidden"
                >
                    <div className="px-4 py-3 flex justify-between items-center">
                        <div className="flex items-center gap-2 text-sm">
                            <Icon name="map-pin" size={14} className="text-blue-200"/>
                            <span>{displayLocation}</span>
                            <span className="opacity-50">|</span>
                            <span>{displayDate}</span>
                            {todayForecast && (
                                <>
                                    <span className="opacity-50">|</span>
                                    <Icon name={todayForecast.code > 50 ? "cloud-rain" : "sun"} size={14} className="text-yellow-300"/>
                                    <span>{todayForecast.min}Â° - {todayForecast.max}Â°C</span>
                                </>
                            )}
                        </div>
                        <Icon name="chevron-down" size={18} className="text-blue-200" />
                    </div>
                </div>
            );
        }

        return (
            <div className="bg-gradient-to-br from-indigo-600 to-blue-500 text-white rounded-b-3xl shadow-lg transition-all duration-300 overflow-hidden relative">
                 <div className="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                    <Icon name="map" size={120} />
                 </div>
                 
                 <div className="p-6 pb-2 relative z-10">
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="text-blue-100 text-sm font-medium">{displayLocation}, æ—¥æœ¬</p>
                            <h1 className="text-3xl font-bold mt-1">
                                {displayDate}
                                {typeof activeDayIndex === 'number' && <span className="text-lg font-normal opacity-80 ml-2">{itineraryData[activeDayIndex].weekday}</span>}
                            </h1>
                            <div className="flex items-center mt-2 space-x-2">
                                {todayForecast ? (
                                    <>
                                        <div className="flex flex-col">
                                            <span className="text-3xl font-light leading-none">{todayForecast.max}Â°</span>
                                            <span className="text-sm opacity-70">æœ€é«˜</span>
                                        </div>
                                        <div className="h-8 w-[1px] bg-white/30 mx-1"></div>
                                        <div className="flex flex-col">
                                            <span className="text-xl font-light leading-none opacity-90">{todayForecast.min}Â°</span>
                                            <span className="text-sm opacity-70">æœ€ä½</span>
                                        </div>
                                        
                                        <span className="ml-2 text-sm bg-white/20 px-3 py-1 rounded-full flex items-center gap-1">
                                            <Icon name={todayForecast.code > 50 ? "cloud-rain" : todayForecast.code <= 3 ? "sun" : "cloud"} size={14} />
                                            {todayForecast.desc}
                                        </span>
                                    </>
                                ) : (
                                    <span className="text-sm animate-pulse">è¼‰å…¥ç•¶åœ°é å ±ä¸­...</span>
                                )}
                            </div>
                        </div>
                        <button onClick={() => setExpanded(false)} className="p-2 bg-white/10 rounded-full hover:bg-white/20 transition">
                            <Icon name="chevron-up" size={20} />
                        </button>
                    </div>
                 </div>

                 <div className="px-6 pb-6 relative z-10">
                    <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 mt-2">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-sm text-blue-100 flex items-center gap-1">
                                <Icon name="coins" size={14} /> å³æ™‚åŒ¯ç‡
                            </span>
                            <span className="text-xs text-blue-200">æ›´æ–°: {rateDate}</span>
                        </div>
                        <div className="flex items-center gap-3">
                            <div className="flex-1 relative">
                                <span className="absolute left-3 top-2.5 text-gray-500 text-sm">Â¥</span>
                                <input 
                                    type="number" 
                                    placeholder="æ—¥å¹£" 
                                    value={amount}
                                    onChange={(e) => setAmount(e.target.value)}
                                    className="w-full pl-7 pr-3 py-2 rounded-lg text-gray-800 text-sm focus:outline-none"
                                />
                            </div>
                            <Icon name="arrow-right" size={16} className="text-white/70" />
                            <div className="flex-1 bg-white/20 rounded-lg py-2 px-3 text-center cursor-pointer active:scale-95 transition" onClick={handleConvert}>
                                {converted ? (
                                    <span className="font-bold">NT$ {converted}</span>
                                ) : (
                                    <span className="text-sm text-blue-100">é»æ“Šæ›ç®—</span>
                                )}
                            </div>
                        </div>
                        <div className="text-center text-xs text-blue-200 mt-2">
                            1 JPY â‰ˆ {jpyRate} TWD
                        </div>
                    </div>
                 </div>
            </div>
        );
    };

    // 4. Modal
    const Modal = ({ isOpen, onClose, data }) => {
        if (!isOpen || !data) return null;

        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
                <div className="bg-white rounded-2xl w-full max-w-md max-h-[80vh] overflow-y-auto z-10 animate-[fadeIn_0.2s_ease-out]">
                    <div className="sticky top-0 bg-white p-4 border-b flex justify-between items-center">
                        <h3 className="font-bold text-lg text-gray-800 truncate pr-4">{data.title}</h3>
                        <button onClick={onClose} className="p-1 bg-gray-100 rounded-full">
                            <Icon name="x" size={20} className="text-gray-600" />
                        </button>
                    </div>
                    <div className="p-5">
                        <div className={`w-12 h-12 ${getColorClass(data.type)} rounded-full flex items-center justify-center mb-4`}>
                            <Icon name={getIconName(data.type)} size={24} />
                        </div>
                        <h4 className="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-1">è©³ç´°è³‡è¨Š</h4>
                        <div className="text-gray-800 whitespace-pre-line leading-relaxed text-sm bg-gray-50 p-4 rounded-lg">
                            {data.details}
                        </div>

                        {data.locationName && (
                            <div className="mt-6">
                                <a 
                                    href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(data.locationName)}`}
                                    target="_blank"
                                    rel="noreferrer"
                                    className="flex items-center justify-center gap-2 w-full py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition"
                                >
                                    <Icon name="map-pin" size={18} />
                                    é–‹å•Ÿ Google Maps
                                </a>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    // 5. Tips Modal
    const TipsModal = ({ isOpen, onClose }) => {
        if (!isOpen) return null;
        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
                <div className="bg-white rounded-2xl w-full max-w-md max-h-[80vh] overflow-y-auto z-10">
                    <div className="p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-gray-800">ğŸ‡¹ğŸ‡¼ å°ç£äººéŠç¦å²¡æ³¨æ„äº‹é …</h2>
                            <button onClick={onClose}><Icon name="x" size={24} /></button>
                        </div>
                        <ul className="space-y-4 text-sm text-gray-700">
                            <li className="flex gap-3">
                                <span className="text-xl">ğŸ’³</span>
                                <span><strong>JCB æ„Ÿæ‡‰ (JCB Contactless)ï¼š</strong>é©ç”¨æ–¼ ç¦å²¡å¸‚åœ°ä¸‹éµå…¨ç·šï¼ˆæ©Ÿå ´ç·šã€ä¸ƒéšˆç·šã€ç®±å´ç·šï¼‰ã€‚é€²å‡ºé–˜é–€æ™‚ç›´æ¥ä½¿ç”¨å¯¦é«”å¡æˆ–æ‰‹æ©Ÿ Apple Pay æ„Ÿæ‡‰ï¼Œå¯äº« 50% å›é¥‹ã€‚</span>
                            </li>
                            <li className="flex gap-3">
                                <span className="text-xl">ğŸšŒ</span>
                                <span><strong>å…¬è»Šå¾Œé–€ä¸Šè»Šï¼š</strong>ç¦å²¡è¥¿éµå·´å£«å¤šç‚ºå¾Œé–€ä¸Šè»Šï¼ˆæŠ½æ•´ç†åˆ¸æˆ–åˆ· IC å¡ï¼‰ï¼Œå‰é–€ä¸‹è»Šä»˜æ¬¾ã€‚</span>
                            </li>
                            <li className="flex gap-3">
                                <span className="text-xl">ğŸš®</span>
                                <span><strong>åƒåœ¾ä¸è½åœ°ï¼š</strong>è·¯é‚Šåƒåœ¾æ¡¶æ¥µå°‘ï¼Œè«‹è‡ªå‚™å¡‘è† è¢‹å°‡åƒåœ¾å¸¶å›é£¯åº—æˆ–ä¾¿åˆ©å•†åº—ä¸Ÿæ£„ã€‚</span>
                            </li>
                            <li className="flex gap-3">
                                <span className="text-xl">ğŸ—£ï¸</span>
                                <span><strong>èªªè©±è¼•è²ï¼š</strong>åœ¨é›»è»Šã€å…¬è»Šå…§è«‹ä¿æŒå®‰éœï¼Œå°‡æ‰‹æ©Ÿè¨­ç‚ºéœéŸ³ã€‚</span>
                            </li>
                            <li className="flex gap-3">
                                <span className="text-xl">ğŸœ</span>
                                <span><strong>å±‹å°æ½›è¦å‰‡ï¼š</strong>æ¯äººè‡³å°‘é»ä¸€æ¯é£²æ–™ï¼Œæ²’å»æ‰€ï¼Œä¸è¦ä¹…åä½”ä½ï¼Œå¤©æ°£å†·è¦æ³¨æ„ä¿æš–ã€‚</span>
                            </li>
                            <li className="flex gap-3">
                                <span className="text-xl">ğŸ›ï¸</span>
                                <span><strong>æ–°å¹´ç‡Ÿæ¥­æ™‚é–“ï¼š</strong>1/2-1/4 å¾ˆå¤šåº—é‹ªç‡Ÿæ¥­æ™‚é–“æœƒèª¿æ•´ï¼Œå»ºè­°å…ˆæŸ¥å¥½å®˜ç¶²ã€‚</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        );
    }

    // --- Main App Component ---
    const App = () => {
        const [activeDayIndex, setActiveDayIndex] = useState(0); // 0-3 or 'all'
        const [viewMode, setViewMode] = useState('timeline'); // 'timeline' | 'map' | 'gallery' | 'souvenir'
        const [modalData, setModalData] = useState(null);
        const [showTips, setShowTips] = useState(false);
        const contentRef = useRef(null);

        // Scroll to top when changing day
        useEffect(() => {
            if(contentRef.current && viewMode === 'timeline') {
                contentRef.current.scrollTop = 0;
            }
            window.scrollTo(0,0);
        }, [activeDayIndex]);

        const currentDayData = typeof activeDayIndex === 'number' ? ITINERARY_DATA[activeDayIndex] : ITINERARY_DATA[0];

        return (
            <div className="min-h-screen pb-24">
                {/* Header & Hero */}
                <div className="sticky top-0 z-30 bg-indigo-600">
                    <div className="flex justify-between items-center px-4 py-3">
                        <span className="text-white font-bold text-lg tracking-wider">FUKUOKA 26'</span>
                        <button 
                            onClick={() => setShowTips(true)}
                            className="bg-white/20 text-white text-xs px-3 py-1.5 rounded-full flex items-center gap-1 hover:bg-white/30 transition"
                        >
                            <Icon name="info" size={14} /> æ—…éŠé ˆçŸ¥
                        </button>
                    </div>
                </div>
                
                <HeroSection activeDayIndex={activeDayIndex} itineraryData={ITINERARY_DATA} />

                {/* Day Switcher */}
                <div className="flex overflow-x-auto hide-scrollbar gap-3 p-4 sticky top-12 z-20 bg-[#f3f4f6]/95 backdrop-blur">
                    {ITINERARY_DATA.map((day, idx) => (
                        <button
                            key={day.dayId}
                            onClick={() => { 
                                setActiveDayIndex(idx); 
                                if (viewMode === 'gallery' || viewMode === 'souvenir') {
                                    // keep current view
                                } else {
                                    setViewMode('timeline');
                                }
                            }}
                            className={`flex-shrink-0 px-4 py-2 rounded-xl flex flex-col items-center min-w-[80px] transition-all border ${
                                activeDayIndex === idx 
                                    ? 'bg-indigo-600 text-white border-indigo-600 shadow-lg scale-105' 
                                    : 'bg-white text-gray-500 border-gray-200'
                            }`}
                        >
                            <span className="text-xs opacity-80">{day.date.slice(5)}</span>
                            <span className="font-bold text-sm">Day {day.dayId}</span>
                        </button>
                    ))}
                    <button
                        onClick={() => { setActiveDayIndex('all'); setViewMode('map'); }}
                        className={`flex-shrink-0 px-4 py-2 rounded-xl flex flex-col items-center min-w-[80px] transition-all border ${
                            activeDayIndex === 'all'
                                ? 'bg-indigo-600 text-white border-indigo-600 shadow-lg scale-105' 
                                : 'bg-white text-gray-500 border-gray-200'
                        }`}
                    >
                        <span className="text-xs opacity-80">All</span>
                        <span className="font-bold text-sm">å…¨ç¨‹</span>
                    </button>
                </div>

                {/* Content Area */}
                <div className="px-4 animate-[fadeIn_0.3s_ease-out]" ref={contentRef}>
                    
                    {viewMode === 'timeline' && typeof activeDayIndex === 'number' && (
                        <>
                            {/* Day Header */}
                            <div className="mb-6 mt-2">
                                <h2 className="text-2xl font-bold text-gray-800">{currentDayData.title}</h2>
                                <p className="text-gray-500 text-sm mt-1 flex items-center gap-1">
                                    <Icon name="tag" size={14} /> {currentDayData.theme}
                                </p>
                            </div>

                            {/* Timeline */}
                            <div className="relative pl-4 border-l-2 border-indigo-200 space-y-8">
                                {currentDayData.locations.map((item, idx) => (
                                    <div key={item.id} className="relative group">
                                        {/* Dot */}
                                        <div className={`absolute -left-[21px] top-4 w-4 h-4 rounded-full border-2 border-white shadow-sm ${getColorClass(item.type).split(' ')[0].replace('bg-', 'bg-')}`}></div>
                                        
                                        {/* Card */}
                                        <div 
                                            className="bg-white rounded-2xl p-4 card-shadow active:scale-[0.98] transition-transform duration-200 cursor-pointer"
                                            onClick={() => setModalData(item)}
                                        >
                                            <div className="flex justify-between items-start mb-2">
                                                <span className="font-mono text-indigo-600 font-bold text-sm bg-indigo-50 px-2 py-1 rounded-md">
                                                    {item.time}
                                                </span>
                                                <div className={`p-2 rounded-full ${getColorClass(item.type)}`}>
                                                    <Icon name={getIconName(item.type)} size={18} />
                                                </div>
                                            </div>
                                            
                                            <h3 className="font-bold text-gray-800 text-lg mb-1">{item.title}</h3>
                                            
                                            <div className="flex items-center gap-1 text-gray-500 text-xs mb-3">
                                                <Icon name="map-pin" size={12} />
                                                <span className="truncate max-w-[200px]">{item.locationName}</span>
                                            </div>

                                            <p className="text-gray-600 text-sm leading-snug">
                                                {item.description}
                                            </p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            
                            {/* Prev/Next Navigation */}
                            <div className="flex justify-between items-center mt-10 mb-6 px-1">
                                <button
                                    disabled={activeDayIndex === 0}
                                    onClick={() => setActiveDayIndex(curr => curr - 1)}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all ${activeDayIndex === 0 ? 'opacity-0 cursor-default' : 'bg-white text-indigo-600 shadow-sm hover:bg-indigo-50 active:scale-95'}`}
                                >
                                    <Icon name="arrow-left" size={16} /> ä¸Šä¸€å¤©
                                </button>
                                
                                <button
                                    disabled={activeDayIndex === ITINERARY_DATA.length - 1}
                                    onClick={() => setActiveDayIndex(curr => curr + 1)}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all ${activeDayIndex === ITINERARY_DATA.length - 1 ? 'opacity-0 cursor-default' : 'bg-indigo-600 text-white shadow-md hover:bg-indigo-700 active:scale-95'}`}
                                >
                                    ä¸‹ä¸€å¤© <Icon name="arrow-right" size={16} />
                                </button>
                            </div>

                            {/* End of day */}
                            <div className="text-center pb-8 text-gray-400 text-sm">
                                ğŸ’¤ Day {currentDayData.dayId} çµæŸ
                            </div>
                        </>
                    )}

                    {viewMode === 'map' && (
                        <div className="mt-2 h-full flex flex-col">
                            <h2 className="text-xl font-bold text-gray-800 mb-4 px-2">
                                {activeDayIndex === 'all' ? 'å…¨ç¨‹åœ°åœ–å°è¦½' : `Day ${activeDayIndex + 1} è·¯ç·šåœ–`}
                            </h2>
                            <MapView activeDay={activeDayIndex} data={ITINERARY_DATA} />
                        </div>
                    )}

                    {viewMode === 'gallery' && (
                        <div className="mt-2">
                            <h2 className="text-xl font-bold text-gray-800 mb-2 px-2">
                                æ—…é€”æ˜ åƒ
                            </h2>
                            <p className="px-2 text-sm text-gray-500">é è¦½æ‚¨çš„ç¦å²¡ä¹‹æ—…æ°›åœ</p>
                            <GalleryView data={activeDayIndex === 'all' ? ITINERARY_DATA : [ITINERARY_DATA[activeDayIndex]]} />
                        </div>
                    )}

                    {viewMode === 'souvenir' && (
                        <SouvenirView />
                    )}
                </div>

                {/* Bottom Navigation */}
                <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-2 py-2 flex justify-between items-center z-40 safe-area-pb shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                    <button 
                        onClick={() => { setViewMode('timeline'); if(activeDayIndex === 'all') setActiveDayIndex(0); }}
                        className={`flex flex-col items-center gap-1 p-2 flex-1 rounded-xl transition ${viewMode === 'timeline' ? 'text-indigo-600 bg-indigo-50' : 'text-gray-400 hover:bg-gray-50'}`}
                    >
                        <Icon name="list" size={20} />
                        <span className="text-[10px] font-medium">è¡Œç¨‹</span>
                    </button>

                    <button 
                        onClick={() => setViewMode('map')}
                        className={`flex flex-col items-center gap-1 p-2 flex-1 rounded-xl transition ${viewMode === 'map' ? 'text-indigo-600 bg-indigo-50' : 'text-gray-400 hover:bg-gray-50'}`}
                    >
                        <Icon name="map" size={20} />
                        <span className="text-[10px] font-medium">åœ°åœ–</span>
                    </button>

                    <button 
                        onClick={() => setViewMode('gallery')}
                        className={`flex flex-col items-center gap-1 p-2 flex-1 rounded-xl transition ${viewMode === 'gallery' ? 'text-indigo-600 bg-indigo-50' : 'text-gray-400 hover:bg-gray-50'}`}
                    >
                        <Icon name="image" size={20} />
                        <span className="text-[10px] font-medium">æ’åœ–</span>
                    </button>

                    <button 
                        onClick={() => setViewMode('souvenir')}
                        className={`flex flex-col items-center gap-1 p-2 flex-1 rounded-xl transition ${viewMode === 'souvenir' ? 'text-indigo-600 bg-indigo-50' : 'text-gray-400 hover:bg-gray-50'}`}
                    >
                        <Icon name="gift" size={20} />
                        <span className="text-[10px] font-medium">ä¼´æ‰‹ç¦®</span>
                    </button>
                </div>

                {/* Modals */}
                <Modal isOpen={!!modalData} onClose={() => setModalData(null)} data={modalData} />
                <TipsModal isOpen={showTips} onClose={() => setShowTips(false)} />

            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

</script>

<style>
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .safe-area-pb {
        padding-bottom: env(safe-area-inset-bottom, 20px);
    }
</style>

</body>
</html>
