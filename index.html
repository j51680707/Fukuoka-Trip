<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¦å²¡ä¹‹æ—… 2026</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS (Open Source Maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans TC", sans-serif;
            background-color: #f3f4f6;
            padding-bottom: 80px; /* Space for bottom nav */
            overscroll-behavior-y: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Map Container */
        #map-container {
            height: calc(100vh - 160px);
            width: 100%;
            z-index: 1;
        }
        .card-shadow {
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">

    const { useState, useEffect, useRef, useMemo } = React;

    // --- Data: Itinerary ---
    const ITINERARY_DATA = [
        {
            dayId: 1,
            date: "2026/01/02",
            weekday: "é€±äº”",
            title: "åˆè³£ç†±æ½®èˆ‡æ˜¥å‰ä¹‹å¤œ",
            theme: "è³¼ç‰©è¡åˆºã€æ‘©æ»‹é‹ã€å¤©ç¥æ¢éšª",
            locations: [
                {
                    id: 'd1-1',
                    time: "12:50",
                    endTime: "16:00",
                    title: "èˆªç­ï¼šTPE - FUK",
                    type: "flight",
                    icon: "Plane",
                    locationName: "ç¦å²¡æ©Ÿå ´ (FUK)",
                    lat: 33.5859, lng: 130.4507,
                    description: "æ­ä¹˜ AK1510ï¼Œæº–å‚™å…¥å¢ƒã€‚",
                    details: "èˆªç­è™Ÿï¼šAK1510\nå‡ºç™¼ï¼šTPE 12:50\næŠµé”ï¼šFUK 16:00\nèˆªå»ˆï¼šåœ‹éš›ç·šèˆªå»ˆ\n\nå‚™è¨»ï¼šå…¥å¢ƒå¯©æŸ¥è«‹é ç•™ 1 å°æ™‚ã€‚"
                },
                {
                    id: 'd1-2',
                    time: "17:30",
                    title: "é£¯åº— Check-in",
                    type: "hotel",
                    icon: "Hotel",
                    locationName: "The BREAKFAST HOTEL ç¦å²¡å¤©ç¥",
                    lat: 33.5890, lng: 130.4020,
                    description: "å¿«é€Ÿæ•´è£ï¼Œæº–å‚™å‡ºé–€è¡€æ‹¼ã€‚",
                    details: "é£¯åº—ï¼šThe BREAKFAST HOTEL ç¦å²¡å¤©ç¥\nåœ°å€ï¼šç¦å²¡å¸‚ä¸­å¤®å€å¤©ç¥\n\næ—©é¤æ”»ç•¥ï¼šä»¥ç¾æ‰“æœæ˜”ã€æŠ«è–©èåã€‚å»ºè­°1/4æ—©ä¸Š6:30ä¸€é–‹é–€å°±å»åƒã€‚"
                },
                {
                    id: 'd1-3',
                    time: "18:00",
                    title: "å¤©ç¥ã€Œåˆè³£ã€å·¡ç¦®",
                    type: "shopping",
                    icon: "ShoppingBag",
                    locationName: "å¤©ç¥åœ°ä¸‹è¡— / PARCO",
                    lat: 33.5900, lng: 130.3980,
                    description: "é–å®šç¦è¢‹èˆ‡åˆè³£æŠ˜æ‰£ (ç™¾è²¨ç´„ 20:00 æ‰“çƒŠ)ã€‚",
                    details: "é‡é»æ”»ç•¥ï¼š\n1. å¤©ç¥åœ°ä¸‹è¡—\n2. ç¦å²¡ PARCO\n3. å²©ç”°å±‹\n\næç¤ºï¼šåˆè³£æ—¥äººæ½®çœ¾å¤šï¼Œçœ‹æº–ç›®æ¨™ç›´æ¥ä¸‹æ‰‹ã€‚"
                },
                {
                    id: 'd1-4',
                    time: "20:00",
                    title: "æ™šé¤ï¼šå…ƒç¥–åšå¤šéººã‚‚ã¤å±‹",
                    type: "food",
                    icon: "Utensils",
                    locationName: "Rakutenchi å¤©ç¥è¥¿é€šåº—",
                    lat: 33.5885, lng: 130.3995,
                    description: "ä¸€äººä»½ç‰›é›œé‹ï¼Œå †æˆå±±çš„éŸ­èœæ˜¯éˆé­‚ã€‚",
                    details: "æ¨è–¦èœå–®ï¼šä¸€äººä»½ç‰›é›œé‹ (Motsunabe)\nç‰¹è‰²ï¼šè’œå‘³æ¹¯é ­æ¿ƒéƒï¼ŒéŸ­èœå †ç–Šå¦‚å±±ã€‚\nå»ºè­°ï¼šæœ€å¾ŒåŠ é»å¼·æ£’éºµåšçµå°¾ã€‚"
                },
                {
                    id: 'd1-5',
                    time: "21:30",
                    title: "ä¸­æ´²/æ˜¥å‰æ•£ç­–",
                    type: "sight",
                    icon: "Moon",
                    locationName: "æ˜¥å‰æ©‹ / é‚£ç‚å·",
                    lat: 33.5915, lng: 130.4070,
                    description: "æ¬£è³é‚£ç‚å·å¤œæ™¯ï¼Œæ„Ÿå—å±‹å°æ°£æ°›ã€‚",
                    details: "è·¯ç·šï¼šå¾é£¯åº—æ­¥è¡Œè‡³æ˜¥å‰æ©‹ã€‚\næ´»å‹•ï¼šæ¬£è³å¤œæ™¯ï¼Œè‹¥æœ‰é¤˜åŠ›å¯è‡³ä¸­æ´²å±‹å°è¡—å–æ¯é£²æ–™ï¼ˆå‰›åƒé£½ä¸å»ºè­°é»é¤ï¼‰ã€‚"
                }
            ]
        },
        {
            dayId: 2,
            date: "2026/01/03",
            weekday: "é€±å…­",
            title: "éœ‡æ’¼ç¥­å…¸èˆ‡å¤§ä½›å·¡ç¦®",
            theme: "å—è—é™¢å¤§ä½›ã€ç®±å´å®®æ¶çƒç¥­",
            locations: [
                {
                    id: 'd2-1',
                    time: "09:00",
                    title: "å‰å¾€å—è—é™¢",
                    type: "transport",
                    icon: "Train",
                    locationName: "åŸæˆ¶å—è—é™¢å‰ç«™",
                    lat: 33.6186, lng: 130.5630,
                    description: "åœ°éµå¤©ç¥å— -> åšå¤š -> JR ç¯ æ —ç·šã€‚",
                    details: "äº¤é€šæ–¹å¼ï¼š\n1. æ­¥è¡Œè‡³å¤©ç¥å—ç«™\n2. æ­ä¸ƒéšˆç·šè‡³åšå¤šç«™\n3. è½‰ä¹˜ JR ç¯ æ —ç·šè‡³ã€ŒåŸæˆ¶å—è—é™¢å‰ã€"
                },
                {
                    id: 'd2-2',
                    time: "10:00",
                    title: "å—è—é™¢ é‡‹è¿¦æ¶…æ§ƒåƒ",
                    type: "sight",
                    icon: "Camera",
                    locationName: "å—è—é™¢",
                    lat: 33.6200, lng: 130.5650,
                    description: "ä¸–ç•Œæœ€å¤§é’éŠ…æ¶…æ§ƒåƒ (å¤–åœ‹éŠå®¢å…¥å ´è²» 300å††)ã€‚",
                    details: "é‡é»ï¼šåƒæ‹œé‡‹è¿¦æ¶…æ§ƒåƒã€‚\næ³¨æ„ï¼šå‹™å¿…æ–¼ 11:30 å‰é›¢é–‹ä»¥è¶•ä¸Šç®±å´å®®ç¥­å…¸ã€‚"
                },
                {
                    id: 'd2-3',
                    time: "13:00",
                    title: "ç®±å´å®®ã€Œç‰å–ç¥­ã€",
                    type: "event",
                    icon: "Flag",
                    locationName: "ç®±å´å®®",
                    lat: 33.6145, lng: 130.4225,
                    description: "ä¹å·ä¸‰å¤§ç¥­å…¸ä¹‹ä¸€ï¼Œæ¶å¥ªé™½çƒçš„ç†±è¡€å ´é¢ã€‚",
                    details: "åˆé¤ï¼šç¥­å…¸å±‹å° (ç‚’éºµã€ç« é­šç‡’)ã€‚\nçœ‹é»ï¼šæ•¸ç™¾åç”·å­çˆ­å¥ªæœ¨çƒï¼Œå ´é¢éœ‡æ’¼ã€‚\näº¤é€šï¼šJRå‰å¡šç«™è½‰åœ°éµè‡³ã€Œç®±å´å®®å‰ã€ã€‚"
                },
                {
                    id: 'd2-4',
                    time: "15:00",
                    title: "æ«›ç”°ç¥ç¤¾ & å·ç«¯å•†åº—è¡—",
                    type: "sight",
                    icon: "MapPin",
                    locationName: "æ«›ç”°ç¥ç¤¾",
                    lat: 33.5930, lng: 130.4105,
                    description: "åƒæ‹œåšå¤šç¸½é®å®ˆï¼Œåƒå·ç«¯å–„å“‰ç´…è±†æ¹¯ã€‚",
                    details: "ä½ç½®ï¼šåœ°éµã€Œä¸­æ´²å·ç«¯ã€ç«™é™„è¿‘ã€‚\nå¿…åƒï¼šå·ç«¯å–„å“‰ (ç´…è±†æ¹¯)ã€‚"
                },
                {
                    id: 'd2-5',
                    time: "18:00",
                    title: "æ™šé¤ï¼šè¯å‘³é³¥ æ°´ç‚Šé‹",
                    type: "food",
                    icon: "Utensils",
                    locationName: "åšå¤šæ°´ç‚Š è¯å‘³é³¥ å¤©ç¥åº—",
                    lat: 33.5895, lng: 130.4000,
                    description: "æ¿ƒéƒé›æ¹¯åº•ï¼Œåšå¤šå¿…åƒæ°´ç‚Šé‹ã€‚",
                    details: "æ¨è–¦ï¼šè¯å‘³é³¥å¥—é¤ã€‚\nç‰¹è‰²ï¼šå…ˆå–æ¹¯ï¼Œå†åƒè‚‰ï¼Œæœ€å¾Œç…®é›œç‚Šã€‚"
                }
            ]
        },
        {
            dayId: 3,
            date: "2026/01/04",
            weekday: "é€±æ—¥",
            title: "ç³»å³¶èˆ‡å®—åƒ Bus Tour",
            theme: "æµ·æ™¯çµ•æ™¯ã€ä¸€è˜­ä¹‹æ£®ã€å…‰ä¹‹å¤§é“",
            locations: [
                {
                    id: 'd3-1',
                    time: "07:45",
                    title: "é›†åˆå‡ºç™¼ (é—œéµ)",
                    type: "alert",
                    icon: "AlertCircle",
                    locationName: "åšå¤šç«™ç¯‰ç´«å£",
                    lat: 33.5905, lng: 130.4220,
                    description: "å»ºè­°æ­è¨ˆç¨‹è»Šè‡³åšå¤šç«™ç¯‰ç´«å£ï¼Œ08:20 é›†åˆã€‚",
                    details: "æ¥µåº¦é‡è¦ï¼šåœ˜é«”è¡Œå‹•ä¸ç­‰äººã€‚\né›†åˆé»ï¼šåšå¤šç«™ç¯‰ç´«å£ Oriental Hotel/Lawson å‰ã€‚\nå»ºè­°ï¼š07:45 é›¢é–‹é£¯åº—ï¼Œç›´æ¥æ­è¨ˆç¨‹è»Šé¿å…è¿·è·¯ (ç´„ 1500å††)ã€‚"
                },
                {
                    id: 'd3-2',
                    time: "09:30",
                    title: "ç™½çµ²ç€‘å¸ƒ & å¤«å©¦å²©",
                    type: "sight",
                    icon: "Camera",
                    locationName: "æ«»äº•äºŒè¦‹æµ¦å¤«å©¦å²©",
                    lat: 33.6420, lng: 130.1980,
                    description: "ç³»å³¶åœ°æ¨™ç™½è‰²é³¥å±…ï¼Œæµ·é¢¨å¼·è«‹ä¿æš–ã€‚",
                    details: "è¡Œç¨‹ï¼š\n1. ç™½çµ²ç€‘å¸ƒ (åƒçƒ¤å±±å¥³é­š)\n2. æ«»äº•äºŒè¦‹æµ¦å¤«å©¦å²© (æ‹ç…§)\n3. æ¤°å­æ¨¹é¦éŸ†"
                },
                {
                    id: 'd3-3',
                    time: "12:40",
                    title: "ä¸€è˜­ä¹‹æ£® (åˆé¤)",
                    type: "food",
                    icon: "Utensils",
                    locationName: "ä¸€è˜­ä¹‹æ£®",
                    lat: 33.5780, lng: 130.2150,
                    description: "å“åšå‰›ç…®å¥½çš„è±šéª¨æ‹‰éºµï¼Œåƒè§€åšç‰©é¤¨ã€‚",
                    details: "æ³¨æ„ï¼šæ–°å¹´æœŸé–“å·¥å» å¯èƒ½åœå·¥ï¼Œä½†é¤å»³æ­£å¸¸ç‡Ÿæ¥­ã€‚è‹¥æ’éšŠå¤ªé•·å»ºè­°åƒéºµåŒ…å……é£¢ï¼Œå…ˆé€›åšç‰©é¤¨ã€‚"
                },
                {
                    id: 'd3-4',
                    time: "16:10",
                    title: "å®®åœ°å¶½ç¥ç¤¾",
                    type: "sight",
                    icon: "Sun",
                    locationName: "å®®åœ°å¶½ç¥ç¤¾",
                    lat: 33.7800, lng: 130.4850,
                    description: "è‘—åçš„ã€Œå…‰ä¹‹å¤§é“ã€ï¼Œåƒé“ç›´é€šå¤§æµ·ã€‚",
                    details: "å‚™è¨»ï¼šå®—åƒé“ä¹‹é©›å¯èƒ½ä¼‘é¤¨ (12/31-1/5)ï¼Œè¡Œç¨‹å¯èƒ½èª¿æ•´ã€‚\nçœ‹é»ï¼šå…‰ä¹‹å¤§é“å¤•é™½çµ•æ™¯ (é›–éæ­£ä¸­ä½†ä¾ç„¶å£¯è§€)ã€‚"
                },
                {
                    id: 'd3-5',
                    time: "19:30",
                    title: "æ™šé¤ï¼šåšå¤šç«™æ‹‰éºµ",
                    type: "food",
                    icon: "Utensils",
                    locationName: "åšå¤šä¸€é›™ æˆ– å¤§åœ°çš„çƒé¾éºµ",
                    lat: 33.5898, lng: 130.4200,
                    description: "è¿”å›åšå¤šç«™ï¼Œäº«ç”¨æ¿ƒéƒè±šéª¨æˆ–æ¸…çˆ½çƒé¾éºµã€‚",
                    details: "æ¨è–¦ï¼š\n1. åšå¤šä¸€é›™ (æ³¡æ²«ç³»è±šéª¨)\n2. å¤§åœ°çš„çƒé¾éºµ (ç‚¸ç‰›è’¡çƒé¾éºµ)"
                }
            ]
        },
        {
            dayId: 4,
            date: "2026/01/05",
            weekday: "é€±ä¸€",
            title: "æ™¨é–“æ•£ç­–èˆ‡å¾å®¹é›¢å¢ƒ",
            theme: "å¤§æ¿ å…¬åœ’ã€æœ€å¾Œæ¡è³¼",
            locations: [
                {
                    id: 'd4-1',
                    time: "08:30",
                    title: "å¤§æ¿ å…¬åœ’æ•£æ­¥",
                    type: "sight",
                    icon: "Coffee",
                    locationName: "å¤§æ¿ å…¬åœ’",
                    lat: 33.5860, lng: 130.3765,
                    description: "æ¹–é‚Šæ•£æ­¥ï¼ŒRoyal Garden Cafe å–å’–å•¡ã€‚",
                    details: "äº¤é€šï¼šåœ°éµå¤©ç¥ç«™ -> å¤§æ¿ å…¬åœ’ç«™ã€‚\næ°£æ°›ï¼šäº«å—ç¦å²¡æœ€å¾Œçš„æ‚ é–’æ—©æ™¨ã€‚"
                },
                {
                    id: 'd4-2',
                    time: "11:00",
                    title: "æœ€å¾Œæ¡è³¼ & åˆé¤",
                    type: "shopping",
                    icon: "ShoppingBag",
                    locationName: "åšå¤šç«™ / å¤©ç¥",
                    lat: 33.5900, lng: 130.4206,
                    description: "è²·æ˜å¤ªå­ã€ç¦ç ‚å±‹è›‹ç³•ã€‚åˆé¤åƒç‰›èˆŒã€‚",
                    details: "åˆé¤æ¨è–¦ï¼šåšå¤šç«™å…§ Tanal (ç‰›èˆŒ) æˆ– åšå¤šéºµè¡—é“ã€‚\nä¼´æ‰‹ç¦®ï¼šåšå¤šé€šé¥…é ­ã€æ˜å¤ªå­ã€‚"
                },
                {
                    id: 'd4-3',
                    time: "14:20",
                    title: "å‰å¾€æ©Ÿå ´",
                    type: "transport",
                    icon: "Plane",
                    locationName: "ç¦å²¡æ©Ÿå ´ (FUK)",
                    lat: 33.5859, lng: 130.4507,
                    description: "æ­è¨ˆç¨‹è»Šæˆ–åœ°éµå‰å¾€ã€‚16:55 èµ·é£›ã€‚",
                    details: "èˆªç­ï¼šAK1511 (FUK - TPE)\næ™‚é–“ï¼š16:55 èµ·é£› - 18:30 æŠµé”\næé†’ï¼šé ç•™æ™‚é–“é€›æ©Ÿå ´å…ç¨…åº—ã€‚"
                }
            ]
        }
    ];

    // --- Components ---

    // 1. Icon Component
    const Icon = ({ name, size = 20, className }) => {
        useEffect(() => {
            lucide.createIcons();
        }, [name]);
        return <i data-lucide={name} width={size} height={size} className={className}></i>;
    };

    const getIconName = (type) => {
        switch(type) {
            case 'flight': return 'plane';
            case 'hotel': return 'bed-double';
            case 'food': return 'utensils';
            case 'shopping': return 'shopping-bag';
            case 'sight': return 'camera';
            case 'transport': return 'train-front';
            case 'alert': return 'alert-circle';
            case 'event': return 'flag';
            default: return 'map-pin';
        }
    };

    const getColorClass = (type) => {
        switch(type) {
            case 'flight': return 'bg-blue-100 text-blue-600';
            case 'hotel': return 'bg-indigo-100 text-indigo-600';
            case 'food': return 'bg-orange-100 text-orange-600';
            case 'shopping': return 'bg-pink-100 text-pink-600';
            case 'sight': return 'bg-green-100 text-green-600';
            case 'alert': return 'bg-red-100 text-red-600';
            default: return 'bg-gray-100 text-gray-600';
        }
    };

    // 2. Map Component (Leaflet)
    const MapView = ({ activeDay, data }) => {
        const mapRef = useRef(null);
        const mapInstanceRef = useRef(null);
        const markersRef = useRef([]);

        useEffect(() => {
            if (!mapInstanceRef.current) {
                mapInstanceRef.current = L.map('map-container').setView([33.5902, 130.4017], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap & CartoDB'
                }).addTo(mapInstanceRef.current);
            }

            // Clear existing markers
            markersRef.current.forEach(marker => mapInstanceRef.current.removeLayer(marker));
            markersRef.current = [];

            let points = [];
            
            const daysToShow = activeDay === 'all' ? data : [data[activeDay]];

            daysToShow.forEach((day, dayIndex) => {
                day.locations.forEach((loc, locIndex) => {
                    const markerColor = dayIndex === 0 ? 'blue' : dayIndex === 1 ? 'green' : dayIndex === 2 ? 'red' : 'orange';
                    
                    // Simple custom icon
                    const myIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color: ${locIndex === 0 ? '#000' : '#4F46E5'}; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">${locIndex + 1}</div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });

                    const marker = L.marker([loc.lat, loc.lng], { icon: myIcon })
                        .addTo(mapInstanceRef.current)
                        .bindPopup(`<b>D${day.dayId} - ${loc.time}</b><br>${loc.title}`);
                    
                    markersRef.current.push(marker);
                    points.push([loc.lat, loc.lng]);
                });
            });

            if (points.length > 0) {
                const bounds = L.latLngBounds(points);
                mapInstanceRef.current.fitBounds(bounds, { padding: [50, 50] });
            }

            // Fix map sizing issues
            setTimeout(() => {
                mapInstanceRef.current.invalidateSize();
            }, 100);

        }, [activeDay, data]);

        return <div id="map-container" className="rounded-xl overflow-hidden shadow-inner"></div>;
    };

    // 3. Hero Section (Forecast + Currency)
    const HeroSection = ({ activeDayIndex, itineraryData }) => {
        const [expanded, setExpanded] = useState(true);
        const [forecast, setForecast] = useState(null);
        const [jpyRate, setJpyRate] = useState(0.22); // Default fallback
        const [amount, setAmount] = useState('');
        const [converted, setConverted] = useState(null);
        const [rateDate, setRateDate] = useState('');

        useEffect(() => {
            // Fetch Daily Forecast (Fukuoka)
            // We get 7 days. We will map index 0 to Day 1, index 1 to Day 2, etc.
            fetch('https://api.open-meteo.com/v1/forecast?latitude=33.5902&longitude=130.4017&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo')
                .then(res => res.json())
                .then(data => setForecast(data.daily))
                .catch(err => console.error("Weather fetch failed", err));

            // Fetch Currency
            fetch('https://api.exchangerate-api.com/v4/latest/JPY')
                .then(res => res.json())
                .then(data => {
                    if(data.rates.TWD) {
                        setJpyRate(data.rates.TWD);
                        setRateDate(data.date);
                    }
                })
                .catch(err => console.error("Rate fetch failed", err));
        }, []);

        const handleConvert = () => {
            if(!amount) return;
            setConverted((parseFloat(amount) * jpyRate).toFixed(0));
        };

        const getWeatherDescription = (code) => {
            if (code === 0) return 'æ™´æœ—';
            if (code <= 3) return 'å¤šé›²';
            if (code <= 48) return 'æœ‰éœ§';
            if (code <= 67) return 'æœ‰é›¨';
            if (code <= 77) return 'é™é›ª';
            if (code <= 82) return 'é™£é›¨';
            return 'é™°é›¨';
        };

        // Determine which forecast day to show
        // If activeDayIndex is 'all', default to 0. Otherwise use the index.
        const currentDayIdx = typeof activeDayIndex === 'number' ? activeDayIndex : 0;
        
        // Safety check if forecast data is ready
        const todayForecast = forecast ? {
            max: forecast.temperature_2m_max[currentDayIdx],
            min: forecast.temperature_2m_min[currentDayIdx],
            code: forecast.weathercode[currentDayIdx],
            desc: getWeatherDescription(forecast.weathercode[currentDayIdx])
        } : null;

        // Display Date Logic
        const displayDate = typeof activeDayIndex === 'number' 
            ? itineraryData[activeDayIndex].date.slice(5) // "01/02"
            : "å…¨ç¨‹ç¸½è¦½";
        
        const displayLocation = typeof activeDayIndex === 'number' 
             ? "ç¦å²¡å¸‚" 
             : "ç¦å²¡ç¸£";

        // If collapsed (minimized)
        if (!expanded) {
            return (
                <div 
                    onClick={() => setExpanded(true)}
                    className="bg-indigo-600 text-white shadow-lg transition-all duration-300 cursor-pointer overflow-hidden"
                >
                    <div className="px-4 py-3 flex justify-between items-center">
                        <div className="flex items-center gap-2 text-sm">
                            <Icon name="map-pin" size={14} className="text-blue-200"/>
                            <span>{displayLocation}</span>
                            <span className="opacity-50">|</span>
                            <span>{displayDate}</span>
                            {todayForecast && (
                                <>
                                    <span className="opacity-50">|</span>
                                    <Icon name={todayForecast.code > 50 ? "cloud-rain" : "sun"} size={14} className="text-yellow-300"/>
                                    <span>{todayForecast.min}Â° - {todayForecast.max}Â°C</span>
                                </>
                            )}
                        </div>
                        <Icon name="chevron-down" size={18} className="text-blue-200" />
                    </div>
                </div>
            );
        }

        // Expanded view
        return (
            <div className="bg-gradient-to-br from-indigo-600 to-blue-500 text-white rounded-b-3xl shadow-lg transition-all duration-300 overflow-hidden relative">
                 <div className="absolute top-0 right-0 p-4 opacity-10">
                    <Icon name="map" size={120} />
                 </div>
                 
                 <div className="p-6 pb-2">
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="text-blue-100 text-sm font-medium">{displayLocation}, æ—¥æœ¬</p>
                            <h1 className="text-3xl font-bold mt-1">
                                {displayDate}
                                {typeof activeDayIndex === 'number' && <span className="text-lg font-normal opacity-80 ml-2">{itineraryData[activeDayIndex].weekday}</span>}
                            </h1>
                            <div className="flex items-center mt-2 space-x-2">
                                {todayForecast ? (
                                    <>
                                        <div className="flex flex-col">
                                            <span className="text-3xl font-light leading-none">{todayForecast.max}Â°</span>
                                            <span className="text-sm opacity-70">æœ€é«˜</span>
                                        </div>
                                        <div className="h-8 w-[1px] bg-white/30 mx-1"></div>
                                        <div className="flex flex-col">
                                            <span className="text-xl font-light leading-none opacity-90">{todayForecast.min}Â°</span>
                                            <span className="text-sm opacity-70">æœ€ä½</span>
                                        </div>
                                        
                                        <span className="ml-2 text-sm bg-white/20 px-3 py-1 rounded-full flex items-center gap-1">
                                            <Icon name={todayForecast.code > 50 ? "cloud-rain" : todayForecast.code <= 3 ? "sun" : "cloud"} size={14} />
                                            {todayForecast.desc}
                                        </span>
                                    </>
                                ) : (
                                    <span className="text-sm animate-pulse">è¼‰å…¥ç•¶åœ°é å ±ä¸­...</span>
                                )}
                            </div>
                        </div>
                        <button onClick={() => setExpanded(false)} className="p-2 bg-white/10 rounded-full hover:bg-white/20 transition">
                            <Icon name="chevron-up" size={20} />
                        </button>
                    </div>
                 </div>

                 <div className="px-6 pb-6">
                    <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 mt-2">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-sm text-blue-100 flex items-center gap-1">
                                <Icon name="coins" size={14} /> å³æ™‚åŒ¯ç‡
                            </span>
                            <span className="text-xs text-blue-200">æ›´æ–°: {rateDate}</span>
                        </div>
                        <div className="flex items-center gap-3">
                            <div className="flex-1 relative">
                                <span className="absolute left-3 top-2.5 text-gray-500 text-sm">Â¥</span>
                                <input 
                                    type="number" 
                                    placeholder="æ—¥å¹£" 
                                    value={amount}
                                    onChange={(e) => setAmount(e.target.value)}
                                    className="w-full pl-7 pr-3 py-2 rounded-lg text-gray-800 text-sm focus:outline-none"
                                />
                            </div>
                            <Icon name="arrow-right" size={16} className="text-white/70" />
                            <div className="flex-1 bg-white/20 rounded-lg py-2 px-3 text-center cursor-pointer active:scale-95 transition" onClick={handleConvert}>
                                {converted ? (
                                    <span className="font-bold">NT$ {converted}</span>
                                ) : (
                                    <span className="text-sm text-blue-100">é»æ“Šæ›ç®—</span>
                                )}
                            </div>
                        </div>
                        <div className="text-center text-xs text-blue-200 mt-2">
                            1 JPY â‰ˆ {jpyRate} TWD
                        </div>
                    </div>
                 </div>
            </div>
        );
    };

    // 4. Modal
    const Modal = ({ isOpen, onClose, data }) => {
        if (!isOpen || !data) return null;

        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
                <div className="bg-white rounded-2xl w-full max-w-md max-h-[80vh] overflow-y-auto z-10 animate-[fadeIn_0.2s_ease-out]">
                    <div className="sticky top-0 bg-white p-4 border-b flex justify-between items-center">
                        <h3 className="font-bold text-lg text-gray-800 truncate pr-4">{data.title}</h3>
                        <button onClick={onClose} className="p-1 bg-gray-100 rounded-full">
                            <Icon name="x" size={20} className="text-gray-600" />
                        </button>
                    </div>
                    <div className="p-5">
                        <div className={`w-12 h-12 ${getColorClass(data.type)} rounded-full flex items-center justify-center mb-4`}>
                            <Icon name={getIconName(data.type)} size={24} />
                        </div>
                        <h4 className="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-1">è©³ç´°è³‡è¨Š</h4>
                        <div className="text-gray-800 whitespace-pre-line leading-relaxed text-sm bg-gray-50 p-4 rounded-lg">
                            {data.details}
                        </div>

                        {data.locationName && (
                            <div className="mt-6">
                                <a 
                                    href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(data.locationName)}`}
                                    target="_blank"
                                    rel="noreferrer"
                                    className="flex items-center justify-center gap-2 w-full py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition"
                                >
                                    <Icon name="map-pin" size={18} />
                                    é–‹å•Ÿ Google Maps
                                </a>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    // 5. Tips Modal
    const TipsModal = ({ isOpen, onClose }) => {
        if (!isOpen) return null;
        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
                <div className="bg-white rounded-2xl w-full max-w-md max-h-[80vh] overflow-y-auto z-10">
                    <div className="p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-gray-800">ğŸ‡¹ğŸ‡¼ å°ç£äººéŠç¦å²¡æ³¨æ„äº‹é …</h2>
                            <button onClick={onClose}><Icon name="x" size={24} /></button>
                        </div>
                        <ul className="space-y-4 text-sm text-gray-700">
                            <li className="flex gap-3">
                                <span className="text-xl">ğŸšŒ</span>
                                <span><strong>å…¬è»Šå¾Œé–€ä¸Šè»Šï¼š</strong>ç¦å²¡è¥¿éµå·´å£«å¤šç‚ºå¾Œé–€ä¸Šè»Šï¼ˆæŠ½æ•´ç†åˆ¸æˆ–åˆ· IC å¡ï¼‰ï¼Œå‰é–€ä¸‹è»Šä»˜æ¬¾ã€‚</span>
                            </li>
                            <li className="flex gap-3">
                                <span className="text-xl">ğŸš®</span>
                                <span><strong>åƒåœ¾ä¸è½åœ°ï¼š</strong>è·¯é‚Šåƒåœ¾æ¡¶æ¥µå°‘ï¼Œè«‹è‡ªå‚™å¡‘è† è¢‹å°‡åƒåœ¾å¸¶å›é£¯åº—æˆ–ä¾¿åˆ©å•†åº—ä¸Ÿæ£„ã€‚</span>
                            </li>
                            <li className="flex gap-3">
                                <span className="text-xl">ğŸ—£ï¸</span>
                                <span><strong>èªªè©±è¼•è²ï¼š</strong>åœ¨é›»è»Šã€å…¬è»Šå…§è«‹ä¿æŒå®‰éœï¼Œå°‡æ‰‹æ©Ÿè¨­ç‚ºéœéŸ³ã€‚</span>
                            </li>
                            <li className="flex gap-3">
                                <span className="text-xl">ğŸœ</span>
                                <span><strong>å±‹å°æ½›è¦å‰‡ï¼š</strong>æ¯äººè‡³å°‘é»ä¸€æ¯é£²æ–™ï¼Œæ²’å»æ‰€ï¼Œä¸è¦ä¹…åä½”ä½ï¼Œå¤©æ°£å†·è¦æ³¨æ„ä¿æš–ã€‚</span>
                            </li>
                            <li className="flex gap-3">
                                <span className="text-xl">ğŸ›ï¸</span>
                                <span><strong>æ–°å¹´ç‡Ÿæ¥­æ™‚é–“ï¼š</strong>1/2-1/4 å¾ˆå¤šåº—é‹ªç‡Ÿæ¥­æ™‚é–“æœƒèª¿æ•´ï¼Œå»ºè­°å…ˆæŸ¥å¥½å®˜ç¶²ã€‚</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        );
    }

    // --- Main App Component ---
    const App = () => {
        const [activeDayIndex, setActiveDayIndex] = useState(0); // 0-3
        const [viewMode, setViewMode] = useState('timeline'); // 'timeline' or 'map'
        const [modalData, setModalData] = useState(null);
        const [showTips, setShowTips] = useState(false);
        const contentRef = useRef(null);

        // Force icon refresh
        useEffect(() => {
            lucide.createIcons();
        }, [activeDayIndex, viewMode, modalData]);

        // Scroll to top when changing day
        useEffect(() => {
            if(contentRef.current && viewMode === 'timeline') {
                contentRef.current.scrollTop = 0;
            }
            window.scrollTo(0,0);
        }, [activeDayIndex]);

        const currentDayData = ITINERARY_DATA[activeDayIndex];

        return (
            <div className="min-h-screen pb-24">
                {/* Header & Hero */}
                <div className="sticky top-0 z-30 bg-indigo-600">
                    <div className="flex justify-between items-center px-4 py-3">
                        <span className="text-white font-bold text-lg tracking-wider">FUKUOKA 26'</span>
                        <button 
                            onClick={() => setShowTips(true)}
                            className="bg-white/20 text-white text-xs px-3 py-1.5 rounded-full flex items-center gap-1 hover:bg-white/30 transition"
                        >
                            <Icon name="info" size={14} /> æ—…éŠé ˆçŸ¥
                        </button>
                    </div>
                </div>
                
                <HeroSection activeDayIndex={activeDayIndex} itineraryData={ITINERARY_DATA} />

                {/* Day Switcher */}
                <div className="flex overflow-x-auto hide-scrollbar gap-3 p-4 sticky top-12 z-20 bg-[#f3f4f6]/95 backdrop-blur">
                    {ITINERARY_DATA.map((day, idx) => (
                        <button
                            key={day.dayId}
                            onClick={() => { setActiveDayIndex(idx); setViewMode('timeline'); }}
                            className={`flex-shrink-0 px-4 py-2 rounded-xl flex flex-col items-center min-w-[80px] transition-all border ${
                                activeDayIndex === idx && viewMode === 'timeline'
                                    ? 'bg-indigo-600 text-white border-indigo-600 shadow-lg scale-105' 
                                    : 'bg-white text-gray-500 border-gray-200'
                            }`}
                        >
                            <span className="text-xs opacity-80">{day.date.slice(5)}</span>
                            <span className="font-bold text-sm">Day {day.dayId}</span>
                        </button>
                    ))}
                </div>

                {/* Content Area */}
                <div className="px-4 animate-[fadeIn_0.3s_ease-out]" ref={contentRef}>
                    
                    {viewMode === 'timeline' ? (
                        <>
                            {/* Day Header */}
                            <div className="mb-6 mt-2">
                                <h2 className="text-2xl font-bold text-gray-800">{currentDayData.title}</h2>
                                <p className="text-gray-500 text-sm mt-1 flex items-center gap-1">
                                    <Icon name="tag" size={14} /> {currentDayData.theme}
                                </p>
                            </div>

                            {/* Timeline */}
                            <div className="relative pl-4 border-l-2 border-indigo-200 space-y-8">
                                {currentDayData.locations.map((item, idx) => (
                                    <div key={item.id} className="relative group">
                                        {/* Dot */}
                                        <div className={`absolute -left-[21px] top-4 w-4 h-4 rounded-full border-2 border-white shadow-sm ${getColorClass(item.type).split(' ')[0].replace('bg-', 'bg-')}`}></div>
                                        
                                        {/* Card */}
                                        <div 
                                            className="bg-white rounded-2xl p-4 card-shadow active:scale-[0.98] transition-transform duration-200 cursor-pointer"
                                            onClick={() => setModalData(item)}
                                        >
                                            <div className="flex justify-between items-start mb-2">
                                                <span className="font-mono text-indigo-600 font-bold text-sm bg-indigo-50 px-2 py-1 rounded-md">
                                                    {item.time}
                                                </span>
                                                <div className={`p-2 rounded-full ${getColorClass(item.type)}`}>
                                                    <Icon name={getIconName(item.type)} size={18} />
                                                </div>
                                            </div>
                                            
                                            <h3 className="font-bold text-gray-800 text-lg mb-1">{item.title}</h3>
                                            
                                            <div className="flex items-center gap-1 text-gray-500 text-xs mb-3">
                                                <Icon name="map-pin" size={12} />
                                                <span className="truncate max-w-[200px]">{item.locationName}</span>
                                            </div>

                                            <p className="text-gray-600 text-sm leading-snug">
                                                {item.description}
                                            </p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            
                            {/* Prev/Next Navigation */}
                            <div className="flex justify-between items-center mt-10 mb-6 px-1">
                                <button
                                    disabled={activeDayIndex === 0}
                                    onClick={() => setActiveDayIndex(curr => curr - 1)}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all ${activeDayIndex === 0 ? 'opacity-0 cursor-default' : 'bg-white text-indigo-600 shadow-sm hover:bg-indigo-50 active:scale-95'}`}
                                >
                                    <Icon name="arrow-left" size={16} /> ä¸Šä¸€å¤©
                                </button>
                                
                                <button
                                    disabled={activeDayIndex === ITINERARY_DATA.length - 1}
                                    onClick={() => setActiveDayIndex(curr => curr + 1)}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all ${activeDayIndex === ITINERARY_DATA.length - 1 ? 'opacity-0 cursor-default' : 'bg-indigo-600 text-white shadow-md hover:bg-indigo-700 active:scale-95'}`}
                                >
                                    ä¸‹ä¸€å¤© <Icon name="arrow-right" size={16} />
                                </button>
                            </div>

                            {/* End of day */}
                            <div className="text-center pb-8 text-gray-400 text-sm">
                                ğŸ’¤ Day {currentDayData.dayId} çµæŸ
                            </div>
                        </>
                    ) : (
                        <div className="mt-2">
                            <h2 className="text-xl font-bold text-gray-800 mb-4 px-2">
                                {activeDayIndex === 'all' ? 'å…¨ç¨‹åœ°åœ–' : `Day ${activeDayIndex + 1} è·¯ç·šåœ–`}
                            </h2>
                            <MapView activeDay={activeDayIndex} data={ITINERARY_DATA} />
                            <div className="mt-4 p-4 bg-white rounded-xl text-sm text-gray-600 shadow-sm">
                                <p className="flex items-center gap-2 mb-2"><span className="w-3 h-3 rounded-full bg-blue-600"></span> Day 1</p>
                                <p className="flex items-center gap-2 mb-2"><span className="w-3 h-3 rounded-full bg-green-600"></span> Day 2</p>
                                <p className="flex items-center gap-2 mb-2"><span className="w-3 h-3 rounded-full bg-red-600"></span> Day 3</p>
                                <p className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-orange-600"></span> Day 4</p>
                            </div>
                        </div>
                    )}
                </div>

                {/* Bottom Navigation */}
                <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-3 flex justify-between items-center z-40 safe-area-pb">
                    <button 
                        onClick={() => setViewMode('timeline')}
                        className={`flex flex-col items-center gap-1 transition ${viewMode === 'timeline' ? 'text-indigo-600' : 'text-gray-400'}`}
                    >
                        <Icon name="list" size={24} />
                        <span className="text-[10px] font-medium">è¡Œç¨‹è¡¨</span>
                    </button>

                    <div 
                        className="w-12 h-12 bg-indigo-600 rounded-full -mt-8 flex items-center justify-center shadow-lg shadow-indigo-300 text-white cursor-pointer hover:bg-indigo-700 transition"
                        onClick={() => {
                            if(viewMode === 'map' && activeDayIndex === 'all') {
                                setViewMode('timeline');
                                setActiveDayIndex(0);
                            } else {
                                setViewMode('map');
                                setActiveDayIndex('all');
                            }
                        }}
                    >
                        <Icon name="map" size={24} />
                    </div>

                    <button 
                        onClick={() => { setViewMode('map'); if(activeDayIndex === 'all') setActiveDayIndex(0); }}
                        className={`flex flex-col items-center gap-1 transition ${viewMode === 'map' && activeDayIndex !== 'all' ? 'text-indigo-600' : 'text-gray-400'}`}
                    >
                        <Icon name="map-pin" size={24} />
                        <span className="text-[10px] font-medium">ç•¶æ—¥åœ°åœ–</span>
                    </button>
                </div>

                {/* Modals */}
                <Modal isOpen={!!modalData} onClose={() => setModalData(null)} data={modalData} />
                <TipsModal isOpen={showTips} onClose={() => setShowTips(false)} />

            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

</script>

<style>
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .safe-area-pb {
        padding-bottom: env(safe-area-inset-bottom, 20px);
    }
</style>

</body>
</html>
